# 软件需求规格说明书 (SRS)
# 学生会值班管理系统

| 文档信息 | |
|----------|----------|
| 版本号 | v1.0 |
| 创建日期 | 2026-01-28 |
| 关联PRD | PRD-值班管理系统.md |

---

## 一、引言

### 1.1 目的

本文档为"学生会值班管理系统"提供完整的软件需求规格说明，供开发团队、测试团队和相关干系人参考使用。

### 1.2 范围

本系统是一个基于Web的值班管理应用，主要功能包括：
- 时间表收集（课表导入：ICS；不可用时间标记）
- 自动排班（满足约束规则，生成排班结果）
- 换班管理（申请、审批流程）
- 签到签退
- 通知提醒

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| 成员 | 参与值班的学生会成员 |
| 时间表 | 成员的课表+其他不可用时间的集合 |
| 硬约束 | 必须满足的排班规则 |
| 软约束 | 尽量满足的优化目标 |
| 单双周 | 按奇偶周区分的周期 |

### 1.4 参考文档

- PRD-值班管理系统.md
- 用户故事-User-Stories.md
- 业务流程描述.md
- 系统配置文件结构.md

---

## 二、系统概述

### 2.1 系统功能模块

系统包含以下核心功能模块：

- **用户管理模块**：用户注册（邀请制/管理员导入）、登录、角色权限管理
- **时间收集模块**：课表导入（ICS；OA拉取V1延期）、不可用时间标记、提交状态管理
- **自动排班模块**：基于约束的排班算法、手动调整、发布
- **换班管理模块**：申请、审批、通知流程
- **签到签退模块**：值班签到、签退、缺席处理
- **通知模块**：邮件提醒、状态通知
- **系统配置模块**：学期、部门、规则、时间段管理

---

## 三、功能需求

### 3.1 用户管理模块 (UM)

#### UM-001 用户注册

| 项目 | 内容 |
|------|------|
| 需求ID | UM-001 |
| 需求名称 | 用户注册 |
| 优先级 | P0 |
| 描述 | 系统仅支持**管理员批量导入**或**邀请链接**方式完成注册/激活；不提供自助注册入口 |

**输入**：
- 方式A：管理员批量导入
  - 姓名（必填，2-20字符）
  - 学号（必填，唯一）
  - 邮箱（必填，有效邮箱格式，唯一；用于通知，不用于登录）
  - 所属组织（默认下拉；预留后续可修改）
  - 所属部门（必填，下拉选择）
- 方式B：邀请链接注册/激活
  - 邀请令牌（必填，来自邀请链接）
  - 密码（必填，8-20字符，包含字母和数字）
  - 确认密码（必填，与密码一致）
  -（可选）邮箱/姓名/部门：若邀请链接已绑定账号信息则前端展示为只读；若未绑定则按管理员配置允许用户补全

**处理逻辑**：
1. 管理员导入：校验必填字段、学号唯一性、邮箱格式与唯一性；创建用户记录并设置默认角色为"值班成员"；可按配置发送激活/通知邮件
2. 邀请链接：校验邀请令牌有效（未过期/未使用/匹配目标账号或允许新建）；校验密码强度；以不可逆方式存储密码（不得明文存储）；将账号状态置为"已激活"

**输出**：
- 成功：注册/激活成功，跳转登录页或直接进入系统（由产品策略决定）
- 失败：显示具体错误信息

---

#### UM-002 用户登录

| 项目 | 内容 |
|------|------|
| 需求ID | UM-002 |
| 需求名称 | 用户登录 |
| 优先级 | P0 |

**输入**：
- 学号（必填）
- 密码（必填）
- 记住我（可选，勾选框）

**处理逻辑**：
1. 根据学号查找用户
2. 验证密码
3. 创建用户登录态（会话）
4. 如勾选"记住我"，登录态有效期为7天；否则为24小时（有效期可配置）

**输出**：
- 成功：根据角色跳转到对应首页
- 失败：显示"学号或密码错误"

---

#### UM-003 角色权限控制

| 项目 | 内容 |
|------|------|
| 需求ID | UM-003 |
| 需求名称 | 角色权限控制 |
| 优先级 | P0 |

**角色定义**：

| 角色 | 权限 |
|------|------|
| 排班管理员 | 全部功能 |
| 部门负责人 | 本部门人员管理、查看提交状态 |
| 值班成员 | 提交时间表、查看排班、签到、申请换班、同意/拒绝换班（作为目标成员） |

**权限矩阵**：

| 功能 | 管理员 | 部门负责人 | 值班成员 |
|------|--------|------------|----------|
| 系统配置 | ✅ | ❌ | ❌ |
| 部门管理 | ✅ | ❌ | ❌ |
| 角色分配 | ✅ | ❌ | ❌ |
| 勾选值班人员 | ✅ | ✅(本部门) | ❌ |
| 查看提交状态 | ✅(全部) | ✅(本部门) | ❌ |
| 执行排班 | ✅ | ❌ | ❌ |
| 手动调整排班 | ✅ | ❌ | ❌ |
| 发布排班 | ✅ | ❌ | ❌ |
| 审核换班 | ✅ | ❌ | ❌ |
| 同意/拒绝换班（目标成员） | ❌ | ❌ | ✅ |
| 提交时间表 | ❌ | ❌ | ✅ |
| 查看排班 | ✅ | ✅ | ✅(本人) |
| 签到签退 | ❌ | ❌ | ✅ |
| 申请换班 | ❌ | ❌ | ✅ |

---

### 3.2 时间收集模块 (TC)

#### TC-001 OA账号课表导入 ⚠️ V1延期

> **V1版本不实现**：OA课表导入功能延期至V2版本，V1仅支持ICS导入。

| 项目 | 内容 |
|------|------|
| 需求ID | TC-001 |
| 需求名称 | OA账号课表导入 |
| 优先级 | P2 (延期) |

**输入**：
- 学校OA账号（必填）
- 学校OA密码（必填）

**处理逻辑**：
1. 调用外部课表解析服务获取课表数据
2. 传递OA账号密码（仅用于本次拉取，不持久化存储）
3. 接收标准化课表数据（至少包含：课程名称、星期几、开始/结束时间、适用周次）
4. 解析并存储到用户时间表

**输出**：
- 成功：日历显示课表，提示"导入成功，共X门课程"
- 失败：显示错误原因（账号密码错误/API超时等）

---

#### TC-002 ICS导入（文件/链接）

| 项目 | 内容 |
|------|------|
| 需求ID | TC-002 |
| 需求名称 | ICS导入（文件/链接） |
| 优先级 | P0 |

**输入**：
- 方式A：ICS文件（.ics格式，最大5MB）
- 方式B：ICS链接（iCalendar订阅链接）
  - 支持协议：`https://`、`http://`、`webcal://`
  - 说明：`webcal://` 视为订阅链接协议，系统需能识别并拉取对应的 ICS 内容

**处理逻辑**：
1. 若为文件导入：验证文件格式和大小
2. 若为链接导入：验证链接格式；拉取 ICS 内容（需有超时与失败提示）
3. 解析ICS内容中的事件与重复规则
4. 提取时间信息并存储到用户时间表

**输出**：
- 成功：日历显示课表，提示"导入成功，共X条记录"
- 失败：显示错误原因（文件格式错误/链接不可访问/链接内容非ICS/超时等）

---

#### TC-003 日历标记不可用时间

| 项目 | 内容 |
|------|------|
| 需求ID | TC-003 |
| 需求名称 | 日历标记不可用时间 |
| 优先级 | P0 |

**界面要求**：
- 支持周视图和月视图切换
- 支持鼠标拖拽选择时间段
- 已有课表以蓝色显示
- 手动标记以橙色显示

**输入（表单）**：
- 开始时间（自动填充拖拽选择的时间）
- 结束时间（自动填充）
- 原因（可选，最大100字符）
- 重复设置：
  - 单次
  - 每周重复

**处理逻辑**：
1. 验证时间段有效性
2. 如选择"每周重复"，生成整学期的时间记录
3. 存储到用户不可用时间表

**输出**：
- 日历实时更新显示
- 支持点击已标记的时间进行编辑或删除

---

#### TC-004 提交时间表

| 项目 | 内容 |
|------|------|
| 需求ID | TC-004 |
| 需求名称 | 提交时间表 |
| 优先级 | P0 |

**前置条件**：
- 至少导入了课表或标记了不可用时间

**处理逻辑**：
1. 检查是否有时间数据
2. 标记用户时间表状态为"已提交"
3. 记录提交时间

**输出**：
- 成功：显示"提交成功"，状态变为已提交
- 可以重新编辑后再次提交

---

#### TC-005 时间表编辑权限限制

| 项目 | 内容 |
|------|------|
| 需求ID | TC-005 |
| 需求名称 | 时间表编辑权限限制 |
| 优先级 | P0 |

**规则**：
1. 仅成员本人可以新增/编辑/删除自己的课表与不可用时间
2. 排班管理员与部门负责人仅可查看成员时间表与提交状态，不得代成员提交或修改

**输出**：
- 非本人尝试修改时：提示"无权限"，并拒绝操作

---

### 3.3 自动排班模块 (AS)

#### AS-001 执行自动排班

| 项目 | 内容 |
|------|------|
| 需求ID | AS-001 |
| 需求名称 | 执行自动排班 |
| 优先级 | P0 |

**前置条件**：
- 当前学期已配置
- 所有需要值班的成员均已提交时间表（提交率=100%）
- 排班规则已配置

**输入**：
- 当前学期ID
- 启用的规则列表

**规则约束与目标（需求层）**：
1. 候选人员范围仅包含：被勾选为"需要值班"且时间表状态为"已提交"的成员
2. 必须满足的硬约束：
   - R1：课表冲突（有课时段不可排）
   - R2：不可用时间冲突（成员标记不可用时段不可排）
   - R6：同一成员同一天最多安排一个班次
3. 可配置启用/禁用的规则：
   - R3：同日部门不重复
   - R4：相邻班次部门不重复
   - R5：单双周早八不重复
4. 优化目标：在满足以上约束前提下，尽量做到值班次数均衡、上学期值过班的人优先级降低

**输出**：
- 成功：返回排班结果，显示日历预览
- 部分成功：返回结果 + 无法安排的时段列表
- 失败：显示"人力不足"提示

---

#### AS-002 手动调整排班

| 项目 | 内容 |
|------|------|
| 需求ID | AS-002 |
| 需求名称 | 手动调整排班 |
| 优先级 | P0 |

**前置条件**：
- 已有排班结果（草稿状态）

**输入**：
- 选择的时段
- 新的值班人员（仅可从当前排班范围内选择）

**处理逻辑**：
1. 获取该时段可用的候选人列表（候选范围=当前排班范围）
2. 用户选择新的值班人员
3. 实时检查是否违反规则
4. 如违反规则，显示具体违反了哪条规则，**不允许保存**
5. 如未违反规则，更新排班结果

**输出**：
- 成功：排班表更新
- 失败：显示违反的规则，不保存

---

#### AS-003 发布排班表

| 项目 | 内容 |
|------|------|
| 需求ID | AS-003 |
| 需求名称 | 发布排班表 |
| 优先级 | P0 |

**前置条件**：
- 排班结果为草稿状态
- 所有时段都已分配

**处理逻辑**：
1. 显示确认对话框
2. 将排班状态改为"已发布"
3. 异步发送邮件通知所有值班成员

**输出**：
- 排班表状态变为"已发布"
- 成员收到邮件通知

---

#### AS-004 发布后修改排班

| 项目 | 内容 |
|------|------|
| 需求ID | AS-004 |
| 需求名称 | 发布后修改排班 |
| 优先级 | P0 |

**前置条件**：
- 排班表状态为"已发布"

**输入**：
- 选择的时段
- 新的值班人员（仅可从当前排班范围内选择）
- 修改原因（可选）

**处理逻辑**：
1. 实时检查规则约束（至少包含 R1/R2/R6，以及当前启用的可配置规则）
2. 允许保存修改
3. 记录变更记录（包含：时段、原值班人员、新值班人员、操作人、操作时间、原因）
4. 发送二次通知：至少通知受影响的成员（被替换者与新安排者）

**输出**：
- 成功：排班表更新，变更记录可查询
- 失败：显示违反的规则，不保存

---

#### AS-005 排班范围变更处理

| 项目 | 内容 |
|------|------|
| 需求ID | AS-005 |
| 需求名称 | 排班范围变更处理 |
| 优先级 | P0 |

**定义**：
排班范围=被勾选为"需要值班"且时间表状态为"已提交"的成员集合。

**规则**：
1. 自动排班生成排班表后，系统应以当时的排班范围作为该排班表的范围基准
2. 若在排班表生成后发生以下任一变化：
  - 新增"需要值班"成员
  - 取消"需要值班"成员
  - 成员提交状态从未提交变为已提交/或反向变化
  则该排班表标记为"需要重新排班"
3. 在"需要重新排班"状态下：
  - 不允许通过手动调整或发布后修改，把班次分配给不在原范围基准内的成员
  - 应提示管理员进行"重新排班"（重新执行自动排班）

---

### 3.4 换班管理模块 (SW)

#### SW-001 申请换班

| 项目 | 内容 |
|------|------|
| 需求ID | SW-001 |
| 需求名称 | 申请换班 |
| 优先级 | P0 |

**前置条件**：
- 申请人有待值班的班次
- 班次在换班截止时间之前

**输入**：
- 要换的班次（从我的排班中选择）
- 目标成员（下拉选择）
- 换班原因（可选）

**处理逻辑**：
1. 检查是否超过截止时间
2. 校验目标成员是否属于排班范围（"需要值班"且时间表状态为"已提交"）
3. 校验目标成员对该班次是否可用（至少校验课表/不可用时间冲突）
4. 校验目标成员在该班次当天是否已有其他值班安排（同日最多一次）
5. 校验通过后创建换班申请记录，状态为"待同意"
6. 发送邮件通知目标成员

**输出**：
- 成功：显示"申请已提交，等待对方同意"
- 失败：显示原因（已超过截止时间/目标成员不在排班范围/目标成员时间冲突/目标成员当日已有值班等）

---

#### SW-002 目标成员同意/拒绝

| 项目 | 内容 |
|------|------|
| 需求ID | SW-002 |
| 需求名称 | 目标成员同意/拒绝 |
| 优先级 | P0 |

**输入**：
- 换班申请ID
- 操作：同意/拒绝

**处理逻辑**：
- 同意：状态变为"待审核"，通知管理员
- 拒绝：状态变为"已拒绝"，通知申请人

---

#### SW-003 管理员审核

| 项目 | 内容 |
|------|------|
| 需求ID | SW-003 |
| 需求名称 | 管理员审核 |
| 优先级 | P0 |

**输入**：
- 换班申请ID
- 操作：批准/驳回

**处理逻辑**：
- 批准：
  1. 再次校验目标成员对该班次是否可用（至少校验课表/不可用时间冲突 不需要校验同日最多一次）
  2. 更新排班表，并记录变更记录
  3. 状态变为"已完成"
  4. 邮件通知双方
- 驳回：
  1. 状态变为"已拒绝"
  2. 邮件通知双方

---

### 3.5 签到签退模块 (SI)

#### SI-001 值班签到

| 项目 | 内容 |
|------|------|
| 需求ID | SI-001 |
| 需求名称 | 值班签到 |
| 优先级 | P0 |

**前置条件**：
- 当前时间在签到窗口内（值班开始前15分钟~值班开始后15分钟）
- 该班次尚未签到

**处理逻辑**：
1. 检查当前时间是否在签到窗口
2. 记录签到时间
3. 判断状态：
   - 值班开始前签到：正常
   - 值班开始后签到：迟到

**输出**：
- 成功：显示"签到成功"，状态更新
- 失败：显示"当前不在签到时间内"

---

#### SI-002 值班签退

| 项目 | 内容 |
|------|------|
| 需求ID | SI-002 |
| 需求名称 | 值班签退 |
| 优先级 | P0 |

**前置条件**：
- 已签到
- 当前时间在签退窗口内（值班结束前15分钟~值班结束后15分钟）

**处理逻辑**：
1. 检查是否已签到
2. 检查当前时间是否在签退窗口
3. 记录签退时间
4. 标记值班完成

**输出**：
- 成功：显示"签退成功，本次值班完成"
- 失败：显示原因（未签到/不在签退时间内）

---

#### SI-003 缺席自动标记

| 项目 | 内容 |
|------|------|
| 需求ID | SI-003 |
| 需求名称 | 缺席自动标记 |
| 优先级 | P0 |

**触发条件**：
- 值班开始后15分钟

**处理逻辑**：
1. 查找所有"值班开始后15分钟仍未签到"的记录
2. 标记为缺席
3. 发送邮件通知管理员

---

#### SI-004 未签退提醒管理员

| 项目 | 内容 |
|------|------|
| 需求ID | SI-004 |
| 需求名称 | 未签退提醒管理员 |
| 优先级 | P0 |

**触发条件**：
- 值班结束后15分钟仍未签退

**处理逻辑**：
1. 标记该次值班记录为"未签退"
2. 通知排班管理员（邮件或站内通知）

---

#### SI-005 缺席后补签

| 项目 | 内容 |
|------|------|
| 需求ID | SI-005 |
| 需求名称 | 缺席后补签 |
| 优先级 | P0 |

**前置条件**：
- 值班记录已被标记为"缺席"

**处理逻辑**：
1. 允许值班成员在缺席标记后继续进行签到操作
2. 系统记录补签时间，并将状态标记为"缺席（已补签）"
3. 通知排班管理员（包含：成员、班次、缺席时间、补签时间）

---

### 3.6 通知模块 (NT)

#### NT-001 值班提醒

| 项目 | 内容 |
|------|------|
| 需求ID | NT-001 |
| 需求名称 | 值班提醒 |
| 优先级 | P0 |

**触发条件**：
- 每日按配置的发送时间触发（默认09:00）

**处理逻辑**：
1. 查询次日所有值班安排
2. 为每个值班成员发送邮件

**邮件模板**：
```
主题：【值班提醒】您明天有值班安排

{姓名} 您好：

您明天（{日期}）有值班安排，请注意时间：
- 时间：{时间段}
- 地点：{值班地点}

请提前15分钟到达并完成签到。

学生会值班管理系统
```

---

### 3.7 导出模块 (EX)

#### EX-001 导出排班表

| 项目 | 内容 |
|------|------|
| 需求ID | EX-001 |
| 需求名称 | 导出排班表 |
| 优先级 | P1 |

**处理逻辑**：
1. 排班管理员可以按学期导出排班表
2. 导出内容至少包含：日期/星期/时间段/值班人员/部门/值班地点
3. 支持常见格式（如CSV/Excel）

---

#### EX-002 导出签到统计

| 项目 | 内容 |
|------|------|
| 需求ID | EX-002 |
| 需求名称 | 导出签到统计 |
| 优先级 | P1 |

**处理逻辑**：
1. 排班管理员可以按学期导出签到统计
2. 导出内容至少包含：成员/部门/班次时间/签到时间/签退时间/状态（准时/迟到/缺席/缺席已补签/未签退）
3. 支持常见格式（如CSV/Excel）

---

## 四、数据需求

### 4.1 核心数据实体

系统需要管理以下核心数据实体：

#### 用户与组织
- **用户 (User)**：学号、姓名、邮箱、密码、角色
- **部门 (Department)**：部门名称、代码、描述、启用状态
- **成员 (Member)**：用户与部门的关联、是否需要值班、年级

#### 时间与排班
- **学期 (Semester)**：名称、开始日期、结束日期、首周类型、状态
- **时间段 (TimeSlot)**：名称、开始时间、结束时间、星期类型
- **不可用时间 (UnavailableTime)**：成员的课表和手动标记的时间
- **排班表 (Schedule)**：学期对应的排班方案、状态
- **排班明细 (ScheduleItem)**：具体的值班安排（谁在什么时候值班）

#### 值班与换班
- **值班记录 (DutyRecord)**：签到时间、签退时间、状态
- **换班申请 (SwapRequest)**：申请人、目标成员、原因、审批状态

### 4.2 数据关系

- 用户与成员：1对1
- 部门与成员：1对多
- 学期与排班表：1对多
- 排班表与排班明细：1对多
- 成员与排班明细：1对多
- 排班明细与值班记录：1对1
- 成员与换班申请：1对多（申请人、目标成员）

### 4.3 数据完整性要求

- 用户学号唯一
- 用户邮箱唯一
- 密码必须加密存储
- 删除部门前必须确保无关联成员
- 排班发布后不可删除，只能归档
- 历史值班记录必须永久保存

---

## 五、非功能需求

### 6.1 性能需求

| 指标 | 要求 |
|------|------|
| 页面首次加载 | < 3秒 |
| 页面交互响应 | < 500ms |
| 自动排班执行 | < 5分钟 (150人规模) |
| 并发用户 | 支持50人同时在线 |
| 数据库查询 | 常用查询 < 100ms |

### 6.2 安全需求

| 项目 | 要求 |
|------|------|
| 密码存储 | 必须加密存储，不可逆 |
| 传输加密 | 必须使用HTTPS |
| 会话管理 | 支持过期和续期机制 |
| 注入攻击防护 | 防止SQL注入、脚本注入 |
| 敏感数据 | OA密码不持久化存储 |
| 权限控制 | 严格的角色权限隔离 |

### 6.3 可用性需求

| 项目 | 要求 |
|------|------|
| 浏览器兼容 | 主流浏览器最新版本 |
| 响应式设计 | 支持PC端和移动端访问 |
| 操作便捷性 | 日历拖拽、实时保存 |
| 错误提示 | 明确的错误信息和操作指引 |
| 学习成本 | 新用户10分钟内掌握基本操作 |

### 6.4 可靠性需求

| 项目 | 要求 |
|------|------|
| 数据备份 | 每日自动备份 |
| 数据恢复 | 支持恢复到任意备份点 |
| 系统可用性 | ≥ 99%（排除计划维护） |
| 错误处理 | 友好的错误提示，不暴露技术细节 |

### 6.5 可维护性需求

| 项目 | 要求 |
|------|------|
| 代码规范 | 统一的代码风格 |
| 日志记录 | 关键操作和错误记录日志 |
| 配置管理 | 配置文件独立，便于修改 |
| 文档完整性 | API文档、部署文档、用户手册 |

### 6.6 可扩展性需求

| 项目 | 要求 |
|------|------|
| 用户规模 | 架构支持扩展至500人 |
| 功能扩展 | 预留多地点值班的扩展可能 |
| 系统集成 | 支持与其他学生会系统对接 |

---

## 六、外部接口需求

### 5.1 课表解析API接口

系统需要调用外部课表解析服务获取学生课表信息。

**接口要求**：
- 支持通过学校OA账号密码获取课表
- 支持解析ICS格式日历文件
- 返回标准化的课程时间数据

**数据格式要求**：
返回的课表数据需包含：
- 课程名称
- 星期几
- 开始时间
- 结束时间
- 适用周次

### 5.2 邮件发送接口

系统需要通过SMTP协议发送邮件通知。

**邮件类型**：
- 值班提醒邮件
- 排班发布通知
- 换班相关通知
- 缺席通知

**发送要求**：
- 支持HTML格式邮件
- 支持邮件模板
- 异步发送，不阻塞主流程

---

## 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2026-01-28 | 初稿 | - |
