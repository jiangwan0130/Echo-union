# 业务流程描述
# 学生会值班管理系统

| 文档信息 | |
|----------|----------|
| 版本号 | v1.0 |
| 创建日期 | 2026-01-28 |
| 关联PRD | PRD-值班管理系统.md |

---

## 一、核心业务流程概览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              系统核心业务流程                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐        │
│    │ 系统配置 │───>│ 时间收集 │───>│ 自动排班 │───>│ 日常值班 │───>│ 换班管理 │        │
│    └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘        │
│         │              │              │              │              │              │
│         v              v              v              v              v              │
│    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐        │
│    │学期/部门 │    │ICS导入   │    │规则检查  │    │签到签退  │    │申请审批  │        │
│    │时间段    │    │日历标记  │    │手动调整  │    │缺席处理  │    │通知更新  │        │
│    │规则配置  │    │提交状态  │    │发布通知  │    │提醒通知  │    │          │        │
│    └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘        │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、详细业务流程

### 流程1：学期初系统配置

**流程编号**：BP-001  
**流程名称**：学期初系统配置  
**触发条件**：新学期开始前  
**参与角色**：排班管理员

```
┌─────────────────────────────────────────────────────────────────────┐
│                        学期初系统配置流程                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│    开始                                                             │
│      │                                                              │
│      v                                                              │
│  ┌────────────────┐                                                │
│  │ 1.创建新学期    │                                                │
│  │ (名称/日期/单双周)│                                               │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐     ┌────────────────┐                        │
│  │ 2.是否需要更新  │──是──>│ 2a.更新部门信息 │                        │
│  │   部门信息？    │      │ (新增/删除/改名) │                        │
│  └────────┬───────┘      └────────┬───────┘                        │
│           │ 否                     │                                │
│           v<──────────────────────┘                                │
│  ┌────────────────┐                                                │
│  │ 3.配置值班时间段 │                                                │
│  │ (确认或修改)    │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 4.配置排班规则  │                                                │
│  │ (启用/禁用规则) │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 5.配置换班截止  │                                                │
│  │   时间         │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│         结束                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**流程步骤说明**：

| 步骤 | 操作 | 输入 | 输出 | 说明 |
|------|------|------|------|------|
| 1 | 创建新学期 | 学期名称、开始日期、结束日期、首周单双周 | 学期记录 | 设为当前活动学期 |
| 2 | 判断是否更新部门 | - | - | 换届时需要更新 |
| 2a | 更新部门信息 | 部门增删改 | 部门列表 | 可选步骤 |
| 3 | 配置时间段 | 周一~周四时间段、周五时间段 | 时间段配置 | 通常沿用上学期 |
| 4 | 配置规则 | 规则开关状态 | 规则配置 | 可按需启用禁用 |
| 5 | 配置换班截止 | 截止时间（如24小时） | 系统参数 | - |

> **v2 Phase 映射**：此流程在 `AdminWorkbench` **Step 1（configuring 阶段）** 中完成。完成后点击「下一步：选定人员」可进入 Step 2。

---

### 流程2：人员名单确定

**流程编号**：BP-002  
**流程名称**：人员名单确定  
**触发条件**：系统配置完成后  
**参与角色**：部门负责人

```
┌─────────────────────────────────────────────────────────────────────┐
│                        人员名单确定流程                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│    开始                                                             │
│      │                                                              │
│      v                                                              │
│  ┌────────────────┐                                                │
│  │ 1.登录系统     │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 2.进入本部门   │                                                │
│  │   成员管理     │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 3.查看成员列表  │                                                │
│  │ (姓名/学号/年级)│                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 4.勾选需要值班  │                                                │
│  │   的成员       │                                                │
│  │ ┌────────────┐ │                                                │
│  │ │☑ 张三 大一  │ │                                                │
│  │ │☑ 李四 大一  │ │                                                │
│  │ │☐ 王五 部长  │ │                                                │
│  │ │☑ 赵六 大二  │ │                                                │
│  │ └────────────┘ │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 5.保存并提交   │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│         结束                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**业务规则**：
- 部长、副部长、留任成员通常不勾选
- 大一成员、大二新招成员需要勾选
- 由部门负责人根据实际情况决定

> **v2 Phase 映射**：此流程在 `AdminWorkbench` **Step 2（configuring 阶段）** 中完成，即 `DutyMemberSelector` 组件。人员勾选完毕后，管理员点击「激活排班」，`semester.phase` 从 `configuring` 推进到 `collecting`。人员勾选现挂在学期维度（`PUT /semesters/:id/duty-members`），替代原来分散在部门接口下的操作。

---

### 流程3：时间表收集

**流程编号**：BP-003  
**流程名称**：时间表收集  
**触发条件**：人员名单确定后  
**参与角色**：值班成员、部门负责人、排班管理员

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              时间表收集流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [值班成员]                      [部门负责人]              [排班管理员]           │
│      │                              │                          │               │
│      v                              │                          │               │
│  ┌────────────┐                    │                          │               │
│  │ 1.登录系统  │                    │                          │               │
│  └─────┬──────┘                    │                          │               │
│        │                            │                          │               │
│        v                            │                          │               │
│  ┌────────────┐                    │                          │               │
│  │ 2.选择课表  │                    │                          │               │
│  │   导入方式  │                    │                          │               │
│  └─────┬──────┘                    │                          │               │
│        │                            │                          │               │
│   ┌────┴────┐                      │                          │               │
│   v         v                       │                          │               │
│ ┌─────┐  ┌─────┐                   │                          │               │
│ │ OA  │  │ ICS │                   │                          │               │
│ │导入 │  │上传 │                   │                          │               │
│ │V1延 │  │     │                   │                          │               │
│ │期   │  │     │                   │                          │               │
│ └──┬──┘  └──┬──┘                   │                          │               │
│    │        │                       │                          │               │
│    v        v                       │                          │               │
│  ┌────────────┐                    │                          │               │
│  │ 3.日历显示  │                    │                          │               │
│  │   课表时间  │                    │                          │               │
│  └─────┬──────┘                    │                          │               │
│        │                            │                          │               │
│        v                            │                          │               │
│  ┌────────────┐                    │                          │               │
│  │ 4.拖拽标记  │                    │                          │               │
│  │ 其他不可用  │                    │                          │               │
│  │   时间     │                    │                          │               │
│  └─────┬──────┘                    │                          │               │
│        │                            │                          │               │
│        v                            │                          │               │
│  ┌────────────┐                    │                          │               │
│  │ 5.提交时间表│                    │                          │               │
│  └─────┬──────┘                    │                          │               │
│        │                            │                          │               │
│        └───────────────────────────>│                          │               │
│                                     v                          │               │
│                              ┌────────────┐                   │               │
│                              │ 6.查看本部门│                   │               │
│                              │   提交状态  │                   │               │
│                              └─────┬──────┘                   │               │
│                                    │                           │               │
│                                    │ 未提交的成员               │               │
│                                    v                           │               │
│                              ┌────────────┐                   │               │
│                              │ 7.提醒未提交│                   │               │
│                              │   成员     │                   │               │
│                              └─────┬──────┘                   │               │
│                                    │                           │               │
│                                    │ 全部提交后                 │               │
│                                    └──────────────────────────>│               │
│                                                                 v               │
│                                                          ┌────────────┐        │
│                                                          │ 8.查看全局 │        │
│                                                          │   提交进度 │        │
│                                                          └─────┬──────┘        │
│                                                                │               │
│                                                                v               │
│                                                          ┌────────────┐        │
│                                                          │ 9.确认可以 │        │
│                                                          │   开始排班 │        │
│                                                          └────────────┘        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**日历标记子流程**：

```
┌─────────────────────────────────────────────────────────┐
│                   日历标记不可用时间                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    ┌─────────────────────────────────────────────┐     │
│    │              周视图 / 月视图                  │     │
│    │  ┌───┬───┬───┬───┬───┬───┬───┐            │     │
│    │  │   │ 一 │ 二 │ 三 │ 四 │ 五 │ 六 │            │     │
│    │  ├───┼───┼───┼───┼───┼───┼───┤            │     │
│    │  │8:00│███│   │███│   │███│   │ ← 课表(灰色) │     │
│    │  │   │███│   │███│   │███│   │            │     │
│    │  ├───┼───┼───┼───┼───┼───┼───┤            │     │
│    │  │12:00│  │   │   │   │   │   │            │     │
│    │  ├───┼───┼───┼───┼───┼───┼───┤            │     │
│    │  │14:00│  │▓▓▓│   │   │   │   │ ← 手动标记  │     │
│    │  │   │   │▓▓▓│   │   │   │   │   (橙色)    │     │
│    │  ├───┼───┼───┼───┼───┼───┼───┤            │     │
│    │  │19:00│  │   │▓▓▓│   │   │   │            │     │
│    │  │   │   │   │▓▓▓│   │   │   │            │     │
│    │  └───┴───┴───┴───┴───┴───┴───┘            │     │
│    └─────────────────────────────────────────────┘     │
│                         │                              │
│                         v 拖拽选择                      │
│              ┌─────────────────────┐                  │
│              │      填写表单        │                  │
│              │ ┌─────────────────┐ │                  │
│              │ │时间: 周三 19-21  │ │                  │
│              │ │原因: 社团活动    │ │                  │
│              │ │重复: ☑每周重复  │ │                  │
│              │ └─────────────────┘ │                  │
│              │   [取消]  [保存]    │                  │
│              └─────────────────────┘                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```
> **v2 Phase 映射**：此流程对应 `semester.phase = collecting`。管理员在 `AdminWorkbench` **Step 3** 监控提交进度；当所有选定人员都提交后，「下一步：排班」按鈕解锁，点击后 Phase 推进到 `scheduling`。成员在 `MemberWorkbench` 待办卡片区看到“请提交你的时间表”卡片，点击展开内嵌时间表填写区。
---

### 流程4：自动排班

**流程编号**：BP-004  
**流程名称**：自动排班  
**触发条件**：时间表收集完成（提交率=100%，且仅统计"需要值班"成员）  
**参与角色**：排班管理员

```
┌─────────────────────────────────────────────────────────────────────┐
│                          自动排班流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│    开始                                                             │
│      │                                                              │
│      v                                                              │
│  ┌────────────────┐                                                │
│  │ 1.确认排班规则  │                                                │
│  │   配置        │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 2.点击"开始   │                                                │
│  │   排班"按钮   │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 3.系统执行排班 │                                                │
│  │   算法        │                                                │
│  │ ┌────────────┐│                                                │
│  │ │正在排班... ││                                                │
│  │ │████████░░░ ││                                                │
│  │ └────────────┘│                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 4.检查排班结果 │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│      ┌────┴────┐                                                   │
│      v         v                                                    │
│  ┌───────┐ ┌───────┐                                              │
│  │ 成功  │ │ 失败  │                                              │
│  └───┬───┘ └───┬───┘                                              │
│      │         │                                                    │
│      v         v                                                    │
│  ┌────────┐ ┌────────────────┐                                    │
│  │5a.显示 │ │5b.显示人力不足 │                                    │
│  │排班预览│ │    提示        │                                    │
│  └───┬────┘ └────────┬───────┘                                    │
│      │               │                                              │
│      │               v                                              │
│      │       ┌────────────────┐                                    │
│      │       │5c.管理员选择： │                                    │
│      │       │ • 调整规则     │                                    │
│      │       │ • 增加人员     │                                    │
│      │       │ • 手动调整     │                                    │
│      │       └────────┬───────┘                                    │
│      │<───────────────┘                                            │
│      v                                                              │
│  ┌────────────────┐                                                │
│  │ 6.查看排班详情 │                                                │
│  │  (日历视图)   │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐     ┌────────────────┐                        │
│  │ 7.是否需要    │──是──>│ 7a.手动调整    │                        │
│  │   手动调整？  │      │ (带规则检查)   │                        │
│  └────────┬───────┘      └────────┬───────┘                        │
│           │ 否                     │                                │
│           v<──────────────────────┘                                │
│  ┌────────────────┐                                                │
│  │ 8.点击"发布"  │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │ 9.确认发布    │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│  ┌────────────────┐                                                │
│  │10.系统发送邮件 │                                                │
│  │   通知所有成员 │                                                │
│  └────────┬───────┘                                                │
│           │                                                         │
│           v                                                         │
│         结束                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**排班算法逻辑说明**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        排班算法流程                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  输入:                                                              │
│    • 所有值班成员的时间表（课表+不可用时间）                           │
│    • 值班时间段配置（26个班次/周 × 2周）                              │
│    • 启用的排班规则                                                  │
│    • 历史值班数据（上学期）                                          │
│                                                                     │
│  算法步骤:                                                           │
│    1. 构建可用性矩阵                                                 │
│       - 对每个成员，标记每个时段是否可用                              │
│                                                                     │
│    2. 应用硬约束过滤                                                 │
│       - 移除课表冲突的候选                                           │
│       - 移除不可用时间冲突的候选                                      │
│                                                                     │
│    3. 贪心/回溯排班                                                  │
│       FOR 每个时段:                                                  │
│         - 获取该时段的可用候选人列表                                  │
│         - 根据规则过滤（同日部门、相邻班次等）                         │
│         - 按优先级排序：                                             │
│           a. 当前值班次数少的优先                                    │
│           b. 上学期值班次数少的优先                                  │
│         - 选择最优候选人                                             │
│         - 如果无候选人，标记该时段无法排班                            │
│                                                                     │
│    4. 输出结果                                                       │
│       - 成功：返回完整排班表                                         │
│       - 失败：返回无法排班的时段列表                                  │
│                                                                     │
│  优化目标:                                                           │
│    • 最小化值班次数方差（均衡性）                                     │
│    • 最大化新人参与（降低老人优先级）                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```
> **v2 Phase 映射**：此流程对应 `semester.phase = scheduling`。`POST /schedules/auto` 前置校验要求 `semester.phase == scheduling`（错误码 13112）。排班表生成后进入手动调整随后发布，`POST /schedules/publish` 成功后后端自动将 `semester.phase` 推进到 `published`。
---

### 流程5：日常值班签到签退

**流程编号**：BP-005  
**流程名称**：日常值班签到签退  
**触发条件**：值班时间到达  
**参与角色**：值班成员、系统

```
┌─────────────────────────────────────────────────────────────────────┐
│                       日常值班签到签退流程                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  [时间线]     [值班成员]              [系统]                         │
│      │            │                     │                           │
│  T-1天           │                     │                           │
│      │            │<────────────────────│                           │
│      │            │   发送值班提醒邮件   │                           │
│      │            │                     │                           │
│  T-15分          │                     │                           │
│      │            │                     │                           │
│      │            v                     │                           │
│      │      ┌──────────┐               │                           │
│      │      │ 到达值班  │               │                           │
│      │      │   地点   │               │                           │
│      │      └────┬─────┘               │                           │
│      │           │                      │                           │
│      │           v                      │                           │
│      │      ┌──────────┐               │                           │
│      │      │ 点击签到  │               │                           │
│      │      └────┬─────┘               │                           │
│      │           │                      │                           │
│      │           │─────────────────────>│                           │
│      │           │                      v                           │
│      │           │               ┌──────────┐                      │
│      │           │               │ 记录签到  │                      │
│      │           │               │ 时间     │                      │
│      │           │               └────┬─────┘                      │
│      │           │                    │                             │
│  T(开始)         │                    v                             │
│      │           │               ┌──────────┐                      │
│      │           │               │ 判断状态  │                      │
│      │           │               └────┬─────┘                      │
│      │           │                    │                             │
│      │           │         ┌──────────┼──────────┐                 │
│      │           │         v          v          v                  │
│      │           │     [准时]     [迟到]     [未签到]               │
│      │           │                                                  │
│      │           │                                                  │
│  T+15分         │                     │                           │
│      │           │                     v                           │
│      │           │               ┌──────────┐                      │
│      │           │               │ 仍未签到？│                      │
│      │           │               └────┬─────┘                      │
│      │           │                    │ 是                          │
│      │           │                    v                             │
│      │           │               ┌──────────┐                      │
│      │           │               │ 标记缺席  │                      │
│      │           │               │ 通知管理员│                      │
│      │           │               └──────────┘                      │
│      │           │                                                  │
│      │           │      （值班中...）                               │
│      │           │                                                  │
│  T+结束-15分     │                     │                           │
│      │           v                     │                           │
│      │      ┌──────────┐               │                           │
│      │      │ 点击签退  │               │                           │
│      │      └────┬─────┘               │                           │
│      │           │                      │                           │
│      │           │─────────────────────>│                           │
│      │           │                      v                           │
│      │           │               ┌──────────┐                      │
│      │           │               │ 记录签退  │                      │
│      │           │               │ 时间     │                      │
│      │           │               └────┬─────┘                      │
│      │           │                    │                             │
│      │           │                    v                             │
│      │           │               ┌──────────┐                      │
│      │           │               │ 本次值班  │                      │
│      │           │               │ 完成     │                      │
│      │           │               └──────────┘                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**签到时间窗口说明**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        签到时间窗口示意                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  以 8:10-10:05 时段为例:                                            │
│                                                                     │
│  7:55          8:10          8:25                   9:50    10:05   │
│    │            │             │                      │        │     │
│    │<──签到窗口──>│<──迟到区间──>│                      │<─签退─>│     │
│    │            │             │                      │  窗口  │     │
│    │  可正常签到 │   签到=迟到  │   超时=缺席           │        │     │
│    │            │             │                      │        │     │
│  ──┼────────────┼─────────────┼──────────────────────┼────────┼──   │
│    │            │             │                      │        │     │
│  T-15min       T(开始)      T+15min               T-15min  T(结束)  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 流程6：换班申请

**流程编号**：BP-006  
**流程名称**：换班申请  
**触发条件**：值班成员需要换班  
**参与角色**：申请人、目标成员、排班管理员

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              换班申请流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [申请人A]              [目标成员B]              [排班管理员]                     │
│      │                      │                        │                          │
│      v                      │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 1.查看我的  │            │                        │                          │
│  │   排班表   │            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│        v                    │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 2.选择要换  │            │                        │                          │
│        v                    │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 4a.校验B对  │            │                        │                          │
│  │  该班次可用 │            │                        │                          │
│  │  (无课/无不可用)
│  │  且当日无其他班次│        │                        │                          │
│  └─────┬──────┘            │                        │                          │
│   ┌────┴────┐              │                        │                          │
│   v         v              │                        │                          │
│ [通过]    [不通过]          │                        │                          │
│   │         │              │                        │                          │
│   │         v              │                        │                          │
│   │    ┌────────┐          │                        │                          │
│   │    │提示:目标│          │                        │                          │
│   │    │成员时间  │          │                        │                          │
│   │    │冲突/当日已有值班│    │                        │                          │
│   │    └────────┘          │                        │                          │
│   │         │              │                        │                          │
│   │         v 结束         │                        │                          │
│   v                        │                        │                          │
│  │   的班次   │            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│        v                    │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 3.是否在截止│            │                        │                          │
│  │   时间内？ │            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│   ┌────┴────┐              │                        │                          │
│   v         v              │                        │                          │
│ [是]      [否]             │                        │                          │
│   │         │              │                        │                          │
│   │         v              │                        │                          │
│   │    ┌────────┐          │                        │                          │
│   │    │提示:已  │          │                        │                          │
│   │    │超过截止│          │                        │                          │
│   │    │时间    │          │                        │                          │
│   │    └────────┘          │                        │                          │
│   │         │              │                        │                          │
│   │         v 结束         │                        │                          │
│   v                        │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 4.选择换班  │            │                        │                          │
│  │   目标成员B │            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│        v                    │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 5.填写换班  │            │                        │                          │
│  │   原因(可选)│            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│        v                    │                        │                          │
│  ┌────────────┐            │                        │                          │
│  │ 6.提交申请  │            │                        │                          │
│  └─────┬──────┘            │                        │                          │
│        │                    │                        │                          │
│        │ 发送通知           │                        │                          │
│        └───────────────────>│                        │                          │
│                             v                        │                          │
│                       ┌────────────┐                │                          │
│                       │ 7.收到换班  │                │                          │
│                       │   请求通知  │                │                          │
│                       └─────┬──────┘                │                          │
│                             │                        │                          │
│                             v                        │                          │
│                       ┌────────────┐                │                          │
│                       │ 8.查看换班  │                │                          │
│                       │   详情     │                │                          │
│                       └─────┬──────┘                │                          │
│                             │                        │                          │
│                             v                        │                          │
│                       ┌────────────┐                │                          │
│                       │ 9.同意/拒绝│                │                          │
│                       └─────┬──────┘                │                          │
│                             │                        │                          │
│                    ┌────────┴────────┐              │                          │
│                    v                 v              │                          │
│                 [同意]            [拒绝]            │                          │
│                    │                 │              │                          │
│                    │                 │──────────────┼─────> 通知A：换班被拒绝   │
│                    │                 │              │       流程结束           │
│                    v                 │              │                          │
│              ┌────────────┐         │              │                          │
│              │10.转交管理员│         │              │                          │
│              │   审核     │         │              │                          │
│              └─────┬──────┘         │              │                          │
│                    │                 │              │                          │
│                    └─────────────────┼─────────────>│                          │
│                                      │              v                          │
│                                      │        ┌────────────┐                  │
│                                      │        │11.收到审核  │                  │
│                                      │        │   请求     │                  │
│                                      │        └─────┬──────┘                  │
│                                      │              │                          │
│                                      │              v                          │
│                                      │        ┌────────────┐                  │
│                                      │        │12.审核换班  │                  │
│                                      │        │   申请     │                  │
│                                      │        └─────┬──────┘                  │
│                                      │              │                          │
│                                      │              v                          │
│                                      │        ┌────────────┐                  │
│                                      │        │12a.再次校验  │                  │
│                                      │        │  B是否可用   │                  │
│                                      │        │(无冲突且当日无其他班次)│         │
│                                      │        └─────┬──────┘                  │
│                                      │              │                          │
│                                      │         ┌────┴────┐                    │
│                                      │         v         v                    │
│                                      │      [批准]    [驳回]                  │
│                                      │         │         │                    │
│                                      │         v         v                    │
│                                      │   ┌─────────┐ ┌─────────┐             │
│                                      │   │13.更新  │ │通知双方 │             │
│                                      │   │排班表   │ │换班失败 │             │
│                                      │   └────┬────┘ └─────────┘             │
│                                      │        │                               │
│                                      │        v                               │
│                                      │   ┌─────────┐                         │
│                                      │   │14.通知  │                         │
│                                      │   │双方换班 │                         │
│                                      │   │成功    │                         │
│                                      │   └─────────┘                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**换班状态流转**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        换班状态流转图                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      ┌─────────────┐                               │
│                      │   待同意    │                               │
│                      │ (Pending)   │                               │
│                      └──────┬──────┘                               │
│                             │                                       │
│              ┌──────────────┼──────────────┐                       │
│              v              │              v                        │
│       ┌───────────┐        │       ┌───────────┐                  │
│       │ B同意     │        │       │ B拒绝     │                  │
│       └─────┬─────┘        │       └─────┬─────┘                  │
│             │              │             │                          │
│             v              │             v                          │
│       ┌───────────┐        │       ┌───────────┐                  │
│       │ 待审核    │        │       │ 已拒绝    │                  │
│       │(Reviewing)│        │       │(Rejected) │                  │
│       └─────┬─────┘        │       └───────────┘                  │
│             │              │             ↑                          │
│      ┌──────┴──────┐       │             │                          │
│      v             v       │             │                          │
│ ┌─────────┐  ┌─────────┐  │             │                          │
│ │管理员批准│  │管理员驳回│──┼─────────────┘                          │
│ └────┬────┘  └─────────┘  │                                        │
│      │                     │                                        │
│      v                     │                                        │
│ ┌───────────┐              │                                        │
│ │ 已完成    │              │                                        │
│ │(Completed)│              │                                        │
│ └───────────┘              │                                        │
│                             │                                        │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、状态机定义

### 3.1 排班表状态

```
┌─────────────────────────────────────────────────────────┐
│                    排班表状态机                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    ┌─────────┐      ┌─────────┐      ┌─────────┐      │
│    │  草稿   │─────>│  已发布  │─────>│  已归档  │      │
│    │ (Draft) │ 发布 │(Published)│ 学期 │(Archived)│      │
│    └────┬────┘      └─────────┘ 结束  └─────────┘      │
│         │                                               │
│         │ 重新排班                                       │
│         └──────────────┐                               │
│                        │                               │
│    新建 ──────────────>│                               │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 值班记录状态

```
┌─────────────────────────────────────────────────────────┐
│                   值班记录状态机                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    ┌─────────┐                                         │
│    │ 待值班  │                                         │
│    │(Pending)│                                         │
│    └────┬────┘                                         │
│         │ 签到                                          │
│         v                                               │
│    ┌─────────┐                                         │
│    │ 值班中  │                                         │
│    │(OnDuty) │                                         │
│    └────┬────┘                                         │
│         │ 签退                                          │
│         v                                               │
│    ┌─────────┐                                         │
│    │ 已完成  │                                         │
│    │(Completed)                                        │
│    └─────────┘                                         │
│                                                         │
│    特殊状态:                                            │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐             │
│    │  迟到   │  │  缺席   │  │ 未签退  │             │
│    │ (Late)  │  │(Absent) │  │(NoSignOut)             │
│    └─────────┘  └─────────┘  └─────────┘             │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 四、业务规则汇总

| 规则编号 | 规则名称 | 规则描述 | 触发场景 |
|----------|----------|----------|----------|
| BR-001 | 课表冲突检查 | 有课时段不可排班 | 自动排班 |
| BR-002 | 不可用时间检查 | 用户标记的不可用时段不可排班 | 自动排班 |
| BR-003 | 同日部门不重复 | 同一天不同时段不能有同部门的人 | 自动排班/手动调整 |
| BR-004 | 相邻班次部门不重复 | 相邻两个时段不能是同部门的人 | 自动排班/手动调整 |
| BR-005 | 单双周早八不重复 | 单周和双周的早八不能是同一人 | 自动排班/手动调整 |
| BR-006 | 签到时间窗口 | 开始前15分钟~开始后15分钟 | 签到 |
| BR-007 | 签退时间窗口 | 结束前15分钟~结束后15分钟 | 签退 |
| BR-008 | 缺席判定 | 开始后15分钟未签到 | 系统自动检查 |
| BR-009 | 换班截止时间 | 超过截止时间不可申请换班 | 换班申请 |

---

## 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2026-01-28 | 初稿 | - |
