# 概要设计说明书 (HLD)
# 学生会值班管理系统

| 文档信息 | |
|----------|----------|
| 版本号 | v1.0 |
| 创建日期 | 2026-01-29 |
| 最后更新 | 2026-01-29 |
| 文档状态 | 初稿 |
| 关联PRD | PRD-值班管理系统.md |
| 关联SRS | SRS-软件需求规格说明.md |

---

## 一、文档概述

### 1.1 目的

本文档为"学生会值班管理系统"提供概要设计说明，描述系统的整体架构、技术选型、模块划分、部署方案及关键设计决策，供开发团队、测试团队和运维团队参考。

### 1.2 范围

本文档覆盖：
- 系统整体架构设计
- 技术栈选型及理由
- 功能模块划分与职责
- 部署架构规划
- 安全设计策略
- 关键设计决策

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| HLD | High-Level Design，概要设计 |
| SPA | Single Page Application，单页面应用 |
| JWT | JSON Web Token，用于用户认证 |
| RBAC | Role-Based Access Control，基于角色的访问控制 |
| CSP | Constraint Satisfaction Problem，约束满足问题 |
| ICS | iCalendar 格式，用于日历数据交换 |

---

## 二、系统概述

### 2.1 系统目标

构建一个基于Web的值班管理平台，实现：
- 值班成员时间表（ICS课表+不可用时间）的在线收集
- 基于约束规则的自动排班
- 换班申请与审批流程
- 签到签退与出勤管理
- 邮件通知与消息中心

### 2.2 系统边界

#### 系统范围内

| 功能域 | 说明 |
|--------|------|
| 用户管理 | 邀请注册、角色权限、部门管理 |
| 时间收集 | ICS导入（文件/链接）、日历标记不可用时间 |
| 自动排班 | 约束规则配置、自动生成、手动调整、发布变更 |
| 换班管理 | 申请、同意、审核三步流程 |
| 签到签退 | Web签到/签退、缺席检测、补签 |
| 通知提醒 | 邮件通知、站内消息、通知偏好配置 |
| 系统配置 | 学期管理、时间段配置、规则开关 |
| 数据导出 | 排班表/签到统计导出（Excel格式） |

#### 系统范围外

| 功能 | 说明 |
|------|------|
| 移动客户端 | 不开发微信小程序/原生APP，仅Web响应式 |
| OA课表导入 | V1不做，仅支持ICS方式 |
| 二维码/定位签到 | 后期迭代 |
| 多地点值班 | V1仅单地点，数据库预留扩展 |
| 统计报表 | V1不做复杂报表 |

### 2.3 用户规模与性能目标

| 指标 | 目标值 |
|------|--------|
| 初期用户规模 | 150-300人 |
| 架构支持扩展 | 500人 |
| 并发用户数 | 50人同时在线 |
| 页面加载时间 | < 3秒 |
| API响应时间 | < 500ms |
| 排班执行时间 | < 5分钟（150人规模） |

---

## 三、系统架构

### 3.1 架构风格

采用 **前后端分离的单体架构**。

**选择理由：**
- 用户规模较小（150-500人），无需微服务复杂度
- 团队规模有限，单体架构降低开发运维成本
- 业务逻辑集中，模块间耦合度较高
- 部署简单，单节点即可满足需求
- 后期可按需拆分为微服务

### 3.2 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   客户端层                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        React SPA (Web Browser)                           │   │
│  │   • PC端 + 移动端响应式布局                                               │   │
│  │   • Ant Design 组件库                                                    │   │
│  │   • FullCalendar 日历组件                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ HTTPS (443)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   接入层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                              Nginx                                       │   │
│  │   • 反向代理 → Go Backend                                                │   │
│  │   • 静态资源服务 (React Build)                                           │   │
│  │   • HTTPS 终止                                                           │   │
│  │   • Gzip 压缩                                                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ HTTP (内网)
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   应用层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                      Go Backend (Gin Framework)                          │   │
│  │                                                                          │   │
│  │  ┌────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      API Layer (Router + Handler)               │    │   │
│  │  │   /api/v1/auth/*   /api/v1/users/*   /api/v1/schedules/*  ...  │    │   │
│  │  └────────────────────────────────────────────────────────────────┘    │   │
│  │                                  │                                       │   │
│  │  ┌────────────────────────────────────────────────────────────────┐    │   │
│  │  │                      Service Layer (业务逻辑)                    │    │   │
│  │  │  AuthSvc │ UserSvc │ TimeSvc │ SchedSvc │ SwapSvc │ DutySvc   │    │   │
│  │  │  NotifySvc │ ConfigSvc │ ExportSvc                             │    │   │
│  │  └────────────────────────────────────────────────────────────────┘    │   │
│  │                                  │                                       │   │
│  │  ┌────────────────────────────────────────────────────────────────┐    │   │
│  │  │                    Repository Layer (数据访问)                   │    │   │
│  │  │  UserRepo │ DeptRepo │ ScheduleRepo │ SwapRepo │ DutyRepo ...  │    │   │
│  │  └────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
┌───────────────────────┐  ┌───────────────────────┐  ┌───────────────────────┐
│       数据层           │  │       缓存层           │  │      外部服务          │
│  ┌─────────────────┐  │  │  ┌─────────────────┐  │  │  ┌─────────────────┐  │
│  │   PostgreSQL    │  │  │  │     Redis       │  │  │  │   SMTP Server   │  │
│  │    15.x         │  │  │  │     7.x         │  │  │  │   (邮件发送)     │  │
│  │                 │  │  │  │                 │  │  │  │                 │  │
│  │  • 业务数据     │  │  │  │  • 会话管理     │  │  │  └─────────────────┘  │
│  │  • 用户信息     │  │  │  │  • Token黑名单  │  │  │                       │
│  │  • 排班记录     │  │  │  │  • 排班任务锁   │  │  │                       │
│  │  • 签到记录     │  │  │  │  • 通知去重     │  │  │                       │
│  └─────────────────┘  │  │  └─────────────────┘  │  │                       │
└───────────────────────┘  └───────────────────────┘  └───────────────────────┘
```

### 3.3 分层架构说明

| 层级 | 职责 | 说明 |
|------|------|------|
| **API Layer** | 请求路由、参数校验、响应封装 | 处理HTTP请求，调用Service层 |
| **Service Layer** | 业务逻辑实现 | 核心业务处理，事务管理 |
| **Repository Layer** | 数据访问抽象 | 封装数据库操作，提供数据访问接口 |
| **Infrastructure** | 基础设施 | 数据库、缓存、外部服务客户端 |

### 3.4 请求处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              典型请求处理流程                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Client          Nginx          Router        Middleware       Handler         │
│    │               │              │              │               │              │
│    │──── HTTPS ───>│              │              │               │              │
│    │               │── HTTP ──────>│              │               │              │
│    │               │              │── 路由匹配 ──>│               │              │
│    │               │              │              │── JWT验证 ────>│              │
│    │               │              │              │── 权限检查 ───>│              │
│    │               │              │              │               │              │
│    │               │              │              │               │              │
│  Handler         Service       Repository     Database                         │
│    │               │              │              │                              │
│    │── 调用服务 ──>│              │              │                              │
│    │               │── 数据访问 ─>│              │                              │
│    │               │              │── SQL ──────>│                              │
│    │               │              │<── 结果 ─────│                              │
│    │               │<── 数据 ─────│              │                              │
│    │<── 结果 ──────│              │              │                              │
│    │                                                                            │
│    │──── JSON Response ────────────────────────────────────────>│              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、技术选型

### 4.1 前端技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 框架 | React | 18.x | 生态成熟，组件化开发 |
| 语言 | TypeScript | 5.x | 类型安全，提升代码质量 |
| 状态管理 | Zustand | 4.x | 轻量简洁，适合中小项目 |
| 路由 | React Router | 6.x | React官方推荐 |
| UI组件库 | Ant Design | 5.x | 企业级组件，功能完善 |
| 日历组件 | FullCalendar | 6.x | 功能强大，支持拖拽 |
| HTTP客户端 | Axios | 1.x | 功能全面，拦截器支持 |
| 构建工具 | Vite | 5.x | 快速构建，开发体验好 |
| 样式方案 | TailwindCSS | 3.x | 原子化CSS，快速开发 |

### 4.2 后端技术栈

| 类别 | 技术 | 版本 | 选型理由 |
|------|------|------|----------|
| 语言 | Go | 1.21+ | 高性能，并发友好，部署简单 |
| Web框架 | Gin | 1.9+ | 生态成熟，文档丰富，性能优秀 |
| ORM | GORM | 2.x | Go主流ORM，功能完善 |
| 认证 | JWT (golang-jwt) | 5.x | 无状态认证，标准方案 |
| 配置管理 | Viper | 1.x | 多格式支持，环境变量集成 |
| 日志 | Zap | 1.x | 高性能结构化日志 |
| 定时任务 | gocron | 2.x | 轻量级定时任务调度 |
| ICS解析 | ical.go | - | 标准ICS格式解析 |
| Excel生成 | Excelize | 2.x | 功能强大，支持样式 |
| 邮件发送 | gomail | 2.x | 简单易用SMTP客户端 |
| 参数校验 | validator | 10.x | 结构体标签校验 |

### 4.3 数据存储

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| 关系数据库 | PostgreSQL | 15+ | 业务数据持久化 |
| 缓存 | Redis | 7+ | 会话管理、分布式锁、去重 |

**PostgreSQL 选型理由：**
- 丰富的数据类型（JSON、数组、时间范围）
- 强事务支持
- 性能优秀
- 开源免费

**Redis 用途：**
- JWT Token 黑名单（登出后失效）
- 排班任务分布式锁（防止并发执行）
- 邮件发送去重（防止重复通知）
- 验证码/邀请码临时存储

### 4.4 基础设施

| 类别 | 技术 | 用途 |
|------|------|------|
| Web服务器 | Nginx 1.24+ | 反向代理、静态资源、HTTPS |
| 容器化 | Docker + Docker Compose | 开发/生产环境统一 |
| 部署平台 | 腾讯云CVM | 生产环境 |

---

## 五、模块设计

### 5.1 后端模块划分

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              后端模块依赖关系                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                              ┌─────────────┐                                   │
│                              │   Export    │                                   │
│                              │   导出服务   │                                   │
│                              └──────┬──────┘                                   │
│                                     │                                           │
│        ┌────────────────────────────┼────────────────────────────┐             │
│        ▼                            ▼                            ▼             │
│  ┌───────────┐              ┌───────────┐              ┌───────────┐          │
│  │ Schedule  │<────────────>│   Swap    │<────────────>│   Duty    │          │
│  │  排班服务  │              │  换班服务  │              │  签到服务  │          │
│  └─────┬─────┘              └─────┬─────┘              └─────┬─────┘          │
│        │                          │                          │                 │
│        └──────────────────────────┼──────────────────────────┘                 │
│                                   │                                             │
│                                   ▼                                             │
│                            ┌───────────┐                                       │
│                            │ TimeTable │                                       │
│                            │ 时间表服务 │                                       │
│                            └─────┬─────┘                                       │
│                                  │                                              │
│        ┌─────────────────────────┼─────────────────────────┐                   │
│        ▼                         ▼                         ▼                   │
│  ┌───────────┐            ┌───────────┐            ┌───────────┐              │
│  │   User    │<──────────>│Department │            │  Config   │              │
│  │  用户服务  │            │  部门服务  │            │  配置服务  │              │
│  └─────┬─────┘            └───────────┘            └───────────┘              │
│        │                                                                        │
│        ▼                                                                        │
│  ┌───────────┐            ┌───────────┐                                        │
│  │   Auth    │            │  Notify   │ <── 被多个模块调用                      │
│  │  认证服务  │            │  通知服务  │                                        │
│  └───────────┘            └───────────┘                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 模块职责说明

| 模块 | 职责 | 核心功能 |
|------|------|----------|
| **Auth** | 认证授权 | 登录、JWT签发/刷新/验证、邀请链接生成与验证 |
| **User** | 用户管理 | 用户CRUD、角色分配、密码管理、批量导入 |
| **Department** | 部门管理 | 部门CRUD、成员关联、"需要值班"勾选 |
| **TimeTable** | 时间收集 | ICS解析、不可用时间CRUD、提交状态管理 |
| **Schedule** | 排班核心 | 自动排班算法、手动调整、发布、变更记录 |
| **Swap** | 换班管理 | 换班申请、冲突校验、审批流程、状态流转 |
| **Duty** | 签到签退 | 签到/签退、时间窗口校验、缺席检测、补签 |
| **Notify** | 通知服务 | 邮件发送、站内消息、通知偏好管理 |
| **Config** | 系统配置 | 学期管理、时间段配置、规则开关、系统参数 |
| **Export** | 数据导出 | 排班表Excel导出、签到统计Excel导出 |

### 5.3 前端模块划分

```
src/
├── assets/                  # 静态资源
├── components/              # 通用组件
│   ├── Calendar/           # 日历组件封装
│   ├── Layout/             # 页面布局
│   ├── Auth/               # 权限组件
│   └── Common/             # 通用UI组件
├── pages/                   # 页面组件
│   ├── Login/              # 登录页
│   ├── Register/           # 注册页（邀请注册）
│   ├── Dashboard/          # 工作台
│   ├── TimeTable/          # 我的时间表
│   ├── Schedule/           # 排班管理
│   │   ├── Overview/       # 排班概览
│   │   ├── Auto/           # 自动排班
│   │   └── Adjust/         # 手动调整
│   ├── Swap/               # 换班管理
│   ├── Duty/               # 签到签退
│   ├── Notification/       # 通知中心
│   ├── Admin/              # 管理后台
│   │   ├── User/           # 用户管理
│   │   ├── Department/     # 部门管理
│   │   └── Config/         # 系统配置
│   └── Profile/            # 个人中心
├── services/                # API服务层
│   ├── api.ts              # Axios实例配置
│   ├── auth.ts             # 认证相关API
│   ├── user.ts             # 用户相关API
│   └── ...
├── stores/                  # Zustand状态管理
│   ├── authStore.ts        # 认证状态
│   ├── userStore.ts        # 用户状态
│   └── ...
├── hooks/                   # 自定义Hooks
├── utils/                   # 工具函数
├── types/                   # TypeScript类型定义
├── constants/               # 常量定义
└── router/                  # 路由配置
```

---

## 六、部署架构

### 6.1 部署拓扑图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              腾讯云 CVM 服务器                                     │
│                              (单节点部署)                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                          Docker Compose                                  │  │
│   │                                                                          │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │  │
│   │  │             │  │             │  │             │  │             │   │  │
│   │  │    Nginx    │  │  Go Backend │  │ PostgreSQL  │  │    Redis    │   │  │
│   │  │             │  │             │  │             │  │             │   │  │
│   │  │  Port: 80   │  │  Port: 8080 │  │  Port: 5432 │  │  Port: 6379 │   │  │
│   │  │       443   │  │  (internal) │  │  (internal) │  │  (internal) │   │  │
│   │  │             │  │             │  │             │  │             │   │  │
│   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │  │
│   │         │                │                │                │          │  │
│   │         └────────────────┴────────────────┴────────────────┘          │  │
│   │                              docker-network                            │  │
│   │                                                                          │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │                           数据卷挂载                                      │  │
│   │                                                                          │  │
│   │   /data/postgres/     PostgreSQL 数据文件                                │  │
│   │   /data/redis/        Redis 持久化数据                                   │  │
│   │   /var/log/app/       应用日志                                          │  │
│   │   /etc/nginx/         Nginx 配置                                        │  │
│   │   /etc/ssl/           SSL 证书                                          │  │
│   │                                                                          │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ 公网
                                        ▼
                              ┌─────────────────┐
                              │    Internet     │
                              │                 │
                              │  域名 + HTTPS   │
                              └─────────────────┘
```

### 6.2 容器配置

| 容器 | 镜像 | 资源限制 | 说明 |
|------|------|----------|------|
| nginx | nginx:1.24-alpine | 256MB | 反向代理+静态资源 |
| backend | 自建镜像 | 512MB | Go应用 |
| postgres | postgres:15-alpine | 1GB | 数据库 |
| redis | redis:7-alpine | 256MB | 缓存 |

### 6.3 环境配置

| 环境 | 用途 | 说明 |
|------|------|------|
| 开发环境 | 本地开发 | Docker Compose 本地启动，热重载 |
| 生产环境 | 线上服务 | 腾讯云单节点，Docker Compose 部署 |

### 6.4 备份策略

| 数据类型 | 备份频率 | 保留周期 | 方式 |
|----------|----------|----------|------|
| PostgreSQL | 每日凌晨 | 7天 | pg_dump + 压缩 |
| Redis | 每日凌晨 | 3天 | RDB快照 |
| 应用日志 | 实时 | 30天 | 文件轮转 |

### 6.5 可观测性与运维

| 类别 | 最小可用方案 | 说明 |
|------|-------------|------|
| 健康检查 | `GET /api/v1/healthz` | 返回应用状态、依赖连通性（DB/Redis 可选） |
| 日志 | 结构化日志（Zap） | 关键字段：request_id、user_id、route、latency_ms、status_code、error_code |
| 慢查询 | GORM 慢查询阈值 | 建议记录 > 200ms 的 SQL（脱敏参数） |
| 定时任务 | 任务执行日志 + 耗时 | 值班提醒/缺席检测/未签退检测等任务记录开始/结束/影响行数 |

> 说明：V1 不强制引入 Prometheus/Tracing；后续如需可扩展 metrics/tracing。

---

## 七、安全设计

### 7.1 认证与授权

#### 7.1.1 认证方案

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              JWT 认证流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌──────────┐                    ┌──────────┐                                 │
│   │  Client  │                    │  Server  │                                 │
│   └────┬─────┘                    └────┬─────┘                                 │
│        │                               │                                        │
│        │ 1. POST /api/v1/auth/login   │                                        │
│        │    {student_id, password, remember_me?}                               │
│        │──────────────────────────────>│                                        │
│        │                               │ 2. 验证凭证                            │
│        │                               │ 3. 生成 Access Token (15min)           │
│        │                               │ 4. 生成 Refresh Token (24h/7d)         │
│        │                               │                                        │
│        │<──────────────────────────────│                                        │
│        │ 5. {accessToken, refreshToken}│                                        │
│        │                               │                                        │
│        │ 6. 存储Token                  │                                        │
│        │    - Access: Memory/LocalStorage                                      │
│        │    - Refresh: HttpOnly Cookie │                                        │
│        │                               │                                        │
│        │ 7. 后续请求                    │                                        │
│        │    Authorization: Bearer {accessToken}                                │
│        │──────────────────────────────>│                                        │
│        │                               │ 8. 验证Token                          │
│        │                               │                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Access Token 有效期 | 15分钟 | 短期有效，降低泄露风险 |
| Refresh Token 有效期 | 24小时（默认）/7天（记住我） | 用于刷新Access Token（以配置为准） |
| 签名算法 | HS256 | HMAC-SHA256 |
| Token黑名单 | Redis存储 | 登出后Token立即失效 |

#### 7.1.2 授权方案 (RBAC)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              角色权限矩阵                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  功能模块              排班管理员    部门负责人    值班成员                        │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  系统配置                  ✅            ❌           ❌                         │
│  部门管理                  ✅            ❌           ❌                         │
│  用户管理/角色分配         ✅            ❌           ❌                         │
│  邀请用户                  ✅            ❌           ❌                         │
│  勾选值班人员              ✅         ✅(本部门)      ❌                         │
│  查看提交状态              ✅(全部)    ✅(本部门)      ❌                         │
│  执行自动排班              ✅            ❌           ❌                         │
│  手动调整排班              ✅            ❌           ❌                         │
│  发布/修改排班             ✅            ❌           ❌                         │
│  审核换班                  ✅            ❌           ❌                         │
│  查看出勤异常              ✅            ❌           ❌                         │
│  导出数据                  ✅            ❌           ❌                         │
│  提交时间表                ❌            ❌           ✅                         │
│  查看排班(全局)            ✅            ✅           ❌                         │
│  查看排班(本人)            ❌            ❌           ✅                         │
│  签到签退                  ❌            ❌           ✅                         │
│  申请换班                  ❌            ❌           ✅                         │
│  同意/拒绝换班             ❌            ❌           ✅                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 数据安全

| 安全项 | 措施 |
|--------|------|
| 密码存储 | bcrypt 加密（cost=12） |
| 传输加密 | 全站 HTTPS |
| SQL注入 | ORM 参数化查询 |
| XSS防护 | 前端转义 + CSP 策略 |
| CSRF防护 | SameSite Cookie + Token |
| 敏感数据 | 邀请码Redis存储，过期自动清理 |

### 7.3 邀请注册安全

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              邀请注册流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  方式一：批量导入                                                                │
│  ─────────────────                                                              │
│  1. 管理员上传 Excel（姓名、学号、邮箱、部门）                                    │
│  2. 系统生成临时密码并创建用户                                                   │
│  3. 发送邮件通知用户（含临时密码）                                               │
│  4. 用户首次登录强制修改密码                                                     │
│                                                                                 │
│  方式二：邀请链接                                                                │
│  ─────────────────                                                              │
│  1. 管理员生成邀请链接（含邀请码）                                               │
│  2. 邀请码存入 Redis，有效期 7 天                                                │
│  3. 用户通过链接注册，需填写姓名、学号、邮箱、密码、部门                          │
│  4. 验证邀请码有效性                                                            │
│  5. 注册成功后邀请码失效                                                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、关键设计决策

### 8.1 排班算法设计

| 决策项 | 方案 |
|--------|------|
| 算法类型 | 约束满足问题 (CSP) + 贪心回溯 |
| 执行方式 | 同步执行（单次调用，等待结果） |
| 执行时间 | < 5分钟（150人规模） |
| 并发控制 | Redis分布式锁，防止重复执行 |
| 无解处理 | 返回部分结果 + 未排时段列表 + 冲突原因 |

**算法核心流程：**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              排班算法流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  输入:                                                                          │
│    • 值班成员列表（需要值班 + 已提交时间表）                                      │
│    • 成员时间表（课表 + 不可用时间）                                             │
│    • 值班时间段配置（周一~四、周五）                                             │
│    • 排班规则配置（启用/禁用状态）                                               │
│    • 上学期值班记录（用于优化均衡）                                              │
│                                                                                 │
│  步骤:                                                                          │
│    1. 构建可用性矩阵                                                            │
│       FOR 每个成员:                                                             │
│         FOR 每个时段:                                                           │
│           检查课表冲突 → 标记不可用                                              │
│           检查不可用时间冲突 → 标记不可用                                         │
│                                                                                 │
│    2. 生成 2 周排班模板                                                          │
│       FOR 每个时段 (按优先级排序):                                               │
│         获取可用候选人列表                                                       │
│         应用硬约束过滤:                                                          │
│           - R6: 同人同日不重复                                                  │
│           - R3: 同日部门不重复（若启用）                                         │
│           - R4: 相邻班次部门不重复（若启用）                                     │
│           - R5: 单双周早八不重复（若启用）                                       │
│         计算候选人优先级:                                                        │
│           - 当前已排班次数少优先                                                 │
│           - 上学期值班次数少优先                                                 │
│         选择最优候选人                                                           │
│         IF 无候选人:                                                            │
│           记录该时段为"无法排班"                                                 │
│                                                                                 │
│    3. 输出结果                                                                  │
│       成功: 完整 2 周排班表                                                      │
│       部分成功: 已排时段 + 未排时段列表 + 原因                                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 定时任务设计

| 任务名称 | 触发规则 | 职责 | 说明 |
|----------|----------|------|------|
| 值班提醒 | 每日可配置时间 | 发送次日值班提醒邮件 | 默认09:00 |
| 缺席检测 | 每分钟 | 检测超时未签到，标记缺席 | 通知管理员 |
| 未签退检测 | 每分钟 | 检测超时未签退 | 通知管理员 |
| 邀请码清理 | 每日凌晨 | 清理过期邀请码 | Redis TTL |

### 8.3 数据保留策略

| 数据类型 | 保留策略 | 说明 |
|----------|----------|------|
| 当前学期 | 完整保留 | 正常使用 |
| 上学期 | 完整保留 | 用于排班优化参考 |
| 更早学期 | 可选清理 | 配置开关控制 |

### 8.4 通知策略

| 通知类型 | 默认状态 | 可配置 | 触发时机 |
|----------|----------|--------|----------|
| 排班发布通知 | 开启 | ✅ | 排班表发布时 |
| 值班提醒 | 开启 | ✅ | 值班前1天 |
| 换班相关通知 | 开启 | ✅ | 申请/同意/审核时 |
| 缺席通知(管理员) | 开启 | ✅ | 成员被标记缺席时 |
| 补签通知(管理员) | 开启 | ✅ | 成员补签时 |

---

## 九、接口设计概览

### 9.1 API 版本管理

采用 URL 路径版本管理：`/api/v1/...`

### 9.2 API 模块划分

| 模块 | 路径前缀 | 说明 |
|------|----------|------|
| 认证 | `/api/v1/auth` | 登录、注册、刷新Token |
| 用户 | `/api/v1/users` | 用户CRUD、批量导入 |
| 部门 | `/api/v1/departments` | 部门CRUD、成员管理 |
| 时间表 | `/api/v1/timetables` | ICS导入、不可用时间 |
| 排班 | `/api/v1/schedules` | 排班CRUD、自动排班 |
| 换班 | `/api/v1/swaps` | 换班申请、审批 |
| 签到 | `/api/v1/duties` | 签到、签退、记录 |
| 通知 | `/api/v1/notifications` | 消息列表、偏好设置 |
| 配置 | `/api/v1/config` | 系统配置 |
| 导出 | `/api/v1/exports` | 数据导出 |

### 9.3 统一响应格式

**成功响应：**
```json
{
  "code": 0,
  "message": "success",
  "data": { ... }
}
```

**错误响应：**
```json
{
  "code": 10001,
  "message": "参数错误",
  "details": "邮箱格式不正确"
}
```

### 9.4 错误码规范

| 错误码范围 | 类型 |
|------------|------|
| 0 | 成功 |
| 10000-10999 | 通用错误（参数、权限等） |
| 11000-11999 | 认证相关错误 |
| 12000-12999 | 用户相关错误 |
| 13000-13999 | 排班相关错误 |
| 14000-14999 | 换班相关错误 |
| 15000-15999 | 签到相关错误 |

---

## 十、风险与缓解措施

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 排班算法无解 | 无法生成完整排班 | 返回部分结果，提示管理员手动处理 |
| 邮件发送失败 | 用户收不到通知 | 重试机制 + 站内消息备份 |
| 单点故障 | 服务不可用 | 定期备份 + 快速恢复流程 |
| ICS解析失败 | 无法导入课表 | 友好错误提示 + 格式校验 |

---

## 十一、后续演进方向

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 多地点值班 | P2 | 数据库已预留扩展 |
| 二维码签到 | P2 | 移动端扫码 |
| 统计报表 | P2 | 可视化图表 |
| 微信通知 | P3 | 对接微信模板消息 |
| 小程序 | P3 | 移动端原生体验 |

---

## 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2026-01-29 | 初稿 | 系统架构师 |

