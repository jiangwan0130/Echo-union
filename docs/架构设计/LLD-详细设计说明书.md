# 详细设计说明书 (LLD)
# 学生会值班管理系统

| 文档信息 | |
|----------|----------|
| 版本号 | v1.0 |
| 创建日期 | 2026-01-29 |
| 最后更新 | 2026-01-29 |
| 文档状态 | 初稿 |
| 关联HLD | HLD-概要设计说明书.md |

---

## 一、文档概述

### 1.1 目的

本文档在《概要设计说明书》基础上，进一步细化各功能模块的内部设计，包括模块职责、组件交互、业务流程、状态机、核心算法逻辑等内容，为开发人员提供详细的实现指导。

### 1.2 范围

本文档覆盖：
- 各模块内部组件设计
- 核心业务流程详细描述
- 状态机定义
- 排班算法详细设计
- 定时任务设计
- 前端页面与组件设计

---

## 二、模块详细设计

### 2.1 认证模块 (Auth)

#### 2.1.1 模块职责

- 用户登录认证
- JWT Token 签发与验证
- Token 刷新机制
- 邀请链接生成与验证
- 登出处理（Token 黑名单）

#### 2.1.2 组件结构

```
auth/
├── handler.go          # HTTP 处理器
│   ├── Login()         # 登录
│   ├── Logout()        # 登出
│   ├── RefreshToken()  # 刷新Token
│   ├── GenerateInvite()# 生成邀请链接
│   └── ValidateInvite()# 验证邀请码
├── service.go          # 业务逻辑
│   ├── Authenticate()  # 验证用户凭证
│   ├── GenerateTokens()# 生成Token对
│   ├── RefreshTokens() # 刷新Token
│   ├── RevokeToken()   # 吊销Token
│   ├── CreateInvite()  # 创建邀请
│   └── VerifyInvite()  # 验证邀请
├── jwt.go              # JWT 工具
│   ├── GenerateAccessToken()
│   ├── GenerateRefreshToken()
│   ├── ParseToken()
│   └── ValidateToken()
└── middleware.go       # 认证中间件
    ├── JWTAuth()       # JWT验证中间件
    └── RoleAuth()      # 角色权限中间件
```

#### 2.1.3 登录流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户登录流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   Client                Handler              Service              Repository   │
│     │                     │                     │                     │        │
│     │ POST /auth/login    │                     │                     │        │
│     │ {student_id, password}│                    │                     │        │
│     │────────────────────>│                     │                     │        │
│     │                     │                     │                     │        │
│     │                     │ 1. 参数校验         │                     │        │
│     │                     │────────────────────>│                     │        │
│     │                     │                     │                     │        │
│     │                     │                     │ 2. 查询用户         │        │
│     │                     │                     │────────────────────>│        │
│     │                     │                     │                     │        │
│     │                     │                     │<────────────────────│        │
│     │                     │                     │    User Entity      │        │
│     │                     │                     │                     │        │
│     │                     │                     │ 3. 验证密码(bcrypt) │        │
│     │                     │                     │                     │        │
│     │                     │                     │ 4. 生成Token对      │        │
│     │                     │                     │    - AccessToken    │        │
│     │                     │                     │    - RefreshToken   │        │
│     │                     │                     │                     │        │
│     │                     │<────────────────────│                     │        │
│     │                     │   TokenPair         │                     │        │
│     │                     │                     │                     │        │
│     │<────────────────────│                     │                     │        │
│     │ 200 OK              │                     │                     │        │
│     │ {accessToken,       │                     │                     │        │
│     │  refreshToken,      │                     │                     │        │
│     │  user}              │                     │                     │        │
│     │                     │                     │                     │        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.1.4 Token 刷新流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Token 刷新流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  1. 客户端检测 AccessToken 即将过期（如剩余 < 2分钟）                              │
│  2. 发送 POST /auth/refresh 携带 RefreshToken                                   │
│     - 推荐：RefreshToken 存储在 HttpOnly Cookie 中，由浏览器自动携带             │
│     - 兼容：非浏览器客户端可在请求体传 refresh_token                           │
│  3. 服务端验证 RefreshToken:                                                    │
│     - 检查签名有效性                                                            │
│     - 检查是否在黑名单中                                                         │
│     - 检查是否过期                                                              │
│  4. 验证通过:                                                                   │
│     - 生成新的 AccessToken                                                      │
│     - 生成新的 RefreshToken                                                     │
│     - 将旧 RefreshToken 加入黑名单                                               │
│  5. 返回新的 Token 对                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.1.5 邀请注册流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              邀请注册流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  方式一：管理员批量导入                                                           │
│  ───────────────────────────────────────────────────────────────────────────   │
│                                                                                 │
│  Admin                  Handler               Service                 Email    │
│    │                      │                      │                      │      │
│    │ POST /users/import   │                      │                      │      │
│    │ Excel文件            │                      │                      │      │
│    │─────────────────────>│                      │                      │      │
│    │                      │                      │                      │      │
│    │                      │ 1. 解析Excel         │                      │      │
│    │                      │─────────────────────>│                      │      │
│    │                      │                      │                      │      │
│    │                      │                      │ 2. FOR 每行数据:     │      │
│    │                      │                      │    - 生成临时密码    │      │
│    │                      │                      │    - 创建用户        │      │
│    │                      │                      │    - 标记需改密码    │      │
│    │                      │                      │                      │      │
│    │                      │                      │ 3. 批量发送邮件      │      │
│    │                      │                      │─────────────────────>│      │
│    │                      │                      │                      │      │
│    │                      │<─────────────────────│                      │      │
│    │<─────────────────────│                      │                      │      │
│    │ 导入结果(成功/失败数) │                      │                      │      │
│                                                                                 │
│  ───────────────────────────────────────────────────────────────────────────   │
│                                                                                 │
│  方式二：邀请链接注册                                                             │
│  ───────────────────────────────────────────────────────────────────────────   │
│                                                                                 │
│  Admin                  Service                Redis                           │
│    │                      │                      │                             │
│    │ 1. 生成邀请链接       │                      │                             │
│    │─────────────────────>│                      │                             │
│    │                      │ 2. 生成邀请码        │                             │
│    │                      │    (UUID/随机字符串)  │                             │
│    │                      │                      │                             │
│    │                      │ 3. 存入Redis         │                             │
│    │                      │    TTL=7天           │                             │
│    │                      │─────────────────────>│                             │
│    │                      │                      │                             │
│    │<─────────────────────│                      │                             │
│    │ 邀请链接              │                      │                             │
│    │ /register?code=xxx   │                      │                             │
│                                                                                 │
│  User                   Handler               Service                Redis    │
│    │                      │                      │                      │      │
│    │ 4. 访问邀请链接       │                      │                      │      │
│    │─────────────────────>│                      │                      │      │
│    │                      │ 5. 验证邀请码        │                      │      │
│    │                      │─────────────────────>│                      │      │
│    │                      │                      │─────────────────────>│      │
│    │                      │                      │<─────────────────────│      │
│    │                      │                      │   邀请码有效         │      │
│    │<─────────────────────│                      │                      │      │
│    │ 显示注册表单          │                      │                      │      │
│    │                      │                      │                      │      │
│    │ 6. 提交注册信息       │                      │                      │      │
│    │─────────────────────>│                      │                      │      │
│    │                      │ 7. 创建用户          │                      │      │
│    │                      │─────────────────────>│                      │      │
│    │                      │                      │ 8. 删除邀请码        │      │
│    │                      │                      │─────────────────────>│      │
│    │<─────────────────────│                      │                      │      │
│    │ 注册成功              │                      │                      │      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 用户模块 (User)

#### 2.2.1 模块职责

- 用户信息 CRUD
- 角色分配与管理
- 用户批量导入
- 密码管理（修改、重置）
- 用户与部门关联

#### 2.2.2 组件结构

```
user/
├── handler.go          # HTTP 处理器
│   ├── GetUser()       # 获取用户信息
│   ├── ListUsers()     # 用户列表（分页、筛选）
│   ├── UpdateUser()    # 更新用户信息
│   ├── DeleteUser()    # 删除用户
│   ├── AssignRole()    # 分配角色
│   ├── ImportUsers()   # 批量导入（handler 仅负责文件验证，解析逻辑委派给 Service 层）
│   ├── ChangePassword()# 修改密码
│   └── ResetPassword() # 重置密码
├── service.go          # 业务逻辑
│   └── ParseImportFile()  # 解析导入 Excel 文件（返回 []ImportUserRow）
└── repository.go       # 数据访问
```

> **实现说明：** Excel 导入的文件解析逻辑已移至 Service 层的 `ParseImportFile(reader io.Reader) ([]ImportUserRow, error)` 方法。Handler 层仅负责文件类型验证和大小限制，然后将文件流传入 Service 层处理。

#### 2.2.3 角色分配规则

| 规则 | 说明 |
|------|------|
| 默认角色 | 新用户默认为"值班成员" |
| 角色唯一 | 每个用户只有一个角色 |
| 角色变更 | 仅管理员可修改他人角色 |
| 自我保护 | 管理员不能降级自己的角色 |

---

### 2.3 部门模块 (Department)

#### 2.3.1 模块职责

- 部门信息 CRUD
- 部门成员管理
- "需要值班"状态勾选
- 部门停用/启用

#### 2.3.2 组件结构

```
department/
├── handler.go          # HTTP 处理器
│   ├── CreateDept()    # 创建部门
│   ├── GetDept()       # 获取部门详情
│   ├── ListDepts()     # 部门列表
│   ├── UpdateDept()    # 更新部门
│   ├── DeleteDept()    # 删除部门
│   ├── ListMembers()   # 获取部门成员
│   └── SetDutyRequired()# 设置需要值班
├── service.go          # 业务逻辑
└── repository.go       # 数据访问
```

#### 2.3.3 勾选值班人员流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           勾选值班人员流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  部门负责人/管理员              系统                                              │
│       │                         │                                               │
│       │ 1. 进入部门成员页面      │                                               │
│       │                         │                                               │
│       │ 2. 查看成员列表          │                                               │
│       │    显示: 姓名、学号、    │                                               │
│       │    年级、是否需要值班    │                                               │
│       │                         │                                               │
│       │ 3. 勾选/取消勾选        │                                               │
│       │    "需要值班"复选框     │                                               │
│       │                         │                                               │
│       │ 4. 保存                 │                                               │
│       │────────────────────────>│                                               │
│       │                         │                                               │
│       │                         │ 5. 更新成员 duty_required 字段                 │
│       │                         │                                               │
│       │                         │ 6. 检查是否影响已有排班                         │
│       │                         │    - 若排班表为草稿: 标记"需重新排班"           │
│       │                         │    - 若排班表已发布: 仅记录，不自动变更         │
│       │                         │                                               │
│       │<────────────────────────│                                               │
│       │ 保存成功                │                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 时间表模块 (TimeTable)

#### 2.4.1 模块职责

- ICS 文件/链接解析
- 课表数据存储
- 不可用时间 CRUD
- 时间表提交状态管理
- 提交进度统计

#### 2.4.2 组件结构

```
timetable/
├── handler.go          # HTTP 处理器
│   ├── ImportICS()     # 导入ICS
│   ├── GetTimeTable()  # 获取时间表
│   ├── AddUnavailable()# 添加不可用时间
│   ├── UpdateUnavailable()# 更新不可用时间
│   ├── DeleteUnavailable()# 删除不可用时间
│   ├── Submit()        # 提交时间表
│   ├── GetProgress()   # 获取提交进度
│   └── GetDeptProgress()# 获取部门提交进度
├── service.go          # 业务逻辑
├── ics_parser.go       # ICS解析器
└── repository.go       # 数据访问
```

#### 2.4.3 ICS 解析流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ICS 解析流程                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  输入: ICS 文件内容 或 ICS 链接                                                   │
│                                                                                 │
│  步骤:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 获取 ICS 内容                                                         │   │
│  │    - 文件: 直接读取                                                       │   │
│  │    - 链接: HTTP GET (支持 https://, http://, webcal://)                  │   │
│  │    - 超时: 30秒                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 2. 解析 ICS 格式                                                         │   │
│  │    - 校验 ICS 格式有效性                                                  │   │
│  │    - 提取 VEVENT 事件                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 3. 处理每个事件                                                          │   │
│  │    FOR 每个 VEVENT:                                                      │   │
│  │      - 提取: SUMMARY (课程名)                                            │   │
│  │      - 提取: DTSTART, DTEND (时间)                                       │   │
│  │      - 提取: RRULE (重复规则)                                            │   │
│  │      - 根据学期范围展开重复事件                                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                          │
│                                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 4. 存储课表数据                                                          │   │
│  │    - 清除该用户本学期旧课表数据                                           │   │
│  │    - 批量插入新课表记录                                                   │   │
│  │    - 返回导入数量                                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  输出: 导入成功条数 或 错误信息                                                   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.4.4 不可用时间数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| user_id | UUID | 用户ID |
| semester_id | UUID | 学期ID |
| day_of_week | INT | 星期几 (1-7) |
| start_time | TIME | 开始时间 |
| end_time | TIME | 结束时间 |
| reason | VARCHAR | 原因（可选） |
| repeat_type | ENUM | 单次/每周重复/双周重复 |
| specific_date | DATE | 特定日期（单次时使用） |
| week_type | ENUM | 单周/双周/每周 |

**约束规则（对应 DB CHECK 约束）：**
- `repeat_type` 允许值: `once` / `weekly` / `biweekly`
- `once` 类型必须指定 `specific_date`，`week_type` 必须为 `all`
- `weekly` 类型不允许 `specific_date`
- `biweekly` 类型不允许 `specific_date`，`week_type` 必须为 `odd` 或 `even`

**DTO 校验方法 `CreateUnavailableTimeRequest.Validate()`：**
```go
switch repeat_type {
case "once":  // specific_date 必填，week_type 必须为 all
case "weekly": // specific_date 禁填
case "biweekly": // specific_date 禁填，week_type 必须为 odd/even
}
```

#### 2.4.5 提交状态管理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           时间表提交状态                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  状态流转:                                                                       │
│                                                                                 │
│     ┌──────────────┐        提交         ┌──────────────┐                      │
│     │    未提交    │ ───────────────────> │    已提交    │                      │
│     │ (not_submitted)                    │  (submitted)  │                      │
│     └──────────────┘ <─────────────────── └──────────────┘                      │
│                           编辑后重新提交                                          │
│                                                                                 │
│  业务规则:                                                                       │
│  - 至少有课表数据或不可用时间才能提交                                              │
│  - 提交后可继续编辑，编辑后需重新提交                                              │
│  - 排班仅对"已提交"的成员进行                                                     │
│  - 提交时记录提交时间                                                            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.5 排班模块 (Schedule)

#### 2.5.1 模块职责

- 排班规则配置
- 自动排班算法执行
- 排班结果存储
- 手动调整（规则校验）
- 排班发布与变更
- 变更记录管理

#### 2.5.2 组件结构

```
schedule/
├── handler.go          # HTTP 处理器
│   ├── GetSchedule()   # 获取排班表
│   ├── AutoSchedule()  # 执行自动排班
│   ├── AdjustSchedule()# 手动调整
│   ├── PublishSchedule()# 发布排班
│   ├── ModifyPublished()# 发布后修改
│   ├── GetChangeLogs() # 获取变更记录
│   └── GetMySchedule() # 获取我的排班
├── service.go          # 业务逻辑
├── algorithm.go        # 排班算法
├── validator.go        # 规则校验器
└── repository.go       # 数据访问
```

#### 2.5.3 排班算法详细设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              排班算法详细流程                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                           第一阶段: 数据准备                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  1. 加载配置数据                                                                │
│     - 当前学期信息（开始日期、结束日期、首周类型）                                │
│     - 值班时间段配置（周一~四、周五）                                            │
│     - 排班规则配置（启用/禁用状态）                                              │
│                                                                                 │
│  2. 加载人员数据                                                                │
│     - 获取所有"需要值班"且"已提交时间表"的成员                                   │
│     - 加载每个成员的课表数据                                                    │
│     - 加载每个成员的不可用时间数据                                              │
│     - 加载上学期值班次数（用于优化）                                            │
│                                                                                 │
│  3. 构建时段列表                                                                │
│     - 生成 2 周的所有值班时段                                                   │
│     - 周一~四: 时段A、B、C、D（4个）                                            │
│     - 周五: 时段A、B、C（3个）                                                  │
│     - 共计: (4×4 + 3) × 2 = 38 个时段                                          │
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         第二阶段: 构建可用性矩阵                            │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  FOR 每个成员 m:                                                                │
│    FOR 每个时段 s:                                                              │
│      available[m][s] = TRUE                                                    │
│                                                                                 │
│      // 检查课表冲突                                                            │
│      IF 成员m在时段s有课:                                                       │
│        available[m][s] = FALSE                                                 │
│        CONTINUE                                                                │
│                                                                                 │
│      // 检查不可用时间冲突                                                       │
│      IF 成员m在时段s标记了不可用:                                                │
│        available[m][s] = FALSE                                                 │
│        CONTINUE                                                                │
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         第三阶段: 贪心排班                                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  初始化:                                                                        │
│    currentCount[m] = 0  // 每个成员当前排班次数                                  │
│    result = []          // 排班结果                                             │
│    unassigned = []      // 无法排班的时段                                        │
│                                                                                 │
│  // 按时段顺序处理（可优化为按可用人数升序，优先处理难排的时段）                     │
│  FOR 每个时段 s:                                                                │
│                                                                                 │
│    // 获取候选人列表                                                            │
│    candidates = []                                                              │
│    FOR 每个成员 m:                                                              │
│      IF available[m][s] == FALSE:                                              │
│        CONTINUE                                                                │
│                                                                                 │
│      // 应用硬约束 R6: 同人同日不重复                                            │
│      IF 成员m在时段s同一天已有排班:                                              │
│        CONTINUE                                                                │
│                                                                                 │
│      // 应用可配置规则 R3: 同日部门不重复                                         │
│      IF R3启用 AND 成员m的部门在时段s同一天已有人排班:                            │
│        CONTINUE                                                                │
│                                                                                 │
│      // 应用可配置规则 R4: 相邻班次部门不重复                                     │
│      IF R4启用 AND 成员m的部门与前一时段相同:                                    │
│        CONTINUE                                                                │
│                                                                                 │
│      // 应用可配置规则 R5: 单双周早八不重复                                       │
│      IF R5启用 AND 时段s是早八 AND 成员m已被排在另一周的早八:                     │
│        CONTINUE                                                                │
│                                                                                 │
│      candidates.append(m)                                                       │
│                                                                                 │
│    // 如果没有候选人                                                            │
│    IF len(candidates) == 0:                                                    │
│      unassigned.append({slot: s, reason: "无可用人员"})                         │
│      CONTINUE                                                                  │
│                                                                                 │
│    // 按优先级排序候选人                                                         │
│    SORT candidates BY:                                                          │
│      1. currentCount[m] ASC      // 当前排班少的优先                            │
│      2. lastSemesterCount[m] ASC // 上学期排班少的优先                          │
│                                                                                 │
│    // 选择最优候选人                                                            │
│    selected = candidates[0]                                                    │
│    result.append({slot: s, member: selected})                                  │
│    currentCount[selected]++                                                    │
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         第四阶段: 输出结果                                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  IF len(unassigned) == 0:                                                      │
│    RETURN {                                                                    │
│      success: true,                                                            │
│      schedule: result,                                                         │
│      stats: {                                                                  │
│        totalSlots: 38,                                                         │
│        assignedSlots: 38,                                                      │
│        memberStats: [...] // 每人排班次数                                       │
│      }                                                                         │
│    }                                                                           │
│  ELSE:                                                                         │
│    RETURN {                                                                    │
│      success: false,                                                           │
│      schedule: result,                                                         │
│      unassigned: unassigned,                                                   │
│      message: "部分时段无法排班，请手动处理或调整规则"                            │
│    }                                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.4 手动调整规则校验

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           手动调整校验流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  输入: 时段ID、新值班人员ID                                                       │
│                                                                                 │
│  校验步骤:                                                                       │
│                                                                                 │
│  1. 基础校验                                                                    │
│     - 新成员是否在排班范围内（需要值班 + 已提交）                                  │
│     - 新成员对该时段是否可用（无课表/不可用时间冲突）                              │
│                                                                                 │
│  2. 硬约束校验                                                                   │
│     - R6: 新成员当天是否已有其他排班？                                           │
│                                                                                 │
│  3. 可配置规则校验（仅当规则启用时）                                              │
│     - R3: 新成员部门当天是否已有人排班？                                         │
│     - R4: 新成员部门是否与相邻时段相同？                                         │
│     - R5: 若为早八，新成员是否已在另一周早八？                                    │
│                                                                                 │
│  校验结果:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                       │   │
│  │    valid: true/false,                                                    │   │
│  │    violations: [                                                         │   │
│  │      { rule: "R3", message: "该成员部门当天已有人值班" },                  │   │
│  │      ...                                                                 │   │
│  │    ]                                                                     │   │
│  │  }                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  若 valid=false，拒绝保存，返回违反的规则列表                                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.5 排班表状态机

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           排班表状态机                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                                                                                 │
│     ┌─────────────────────────────────────────────────────────────────────┐    │
│     │                                                                     │    │
│     │            ┌─────────┐                                             │    │
│     │            │         │                                             │    │
│     │   创建     │  草稿   │  重新排班                                    │    │
│     │ ─────────> │ (DRAFT) │ <─────────────────────────┐                 │    │
│     │            │         │                           │                 │    │
│     │            └────┬────┘                           │                 │    │
│     │                 │                                │                 │    │
│     │                 │ 发布                           │                 │    │
│     │                 ▼                                │                 │    │
│     │            ┌─────────┐                     ┌─────┴─────┐           │    │
│     │            │         │                     │           │           │    │
│     │            │ 已发布  │ ──────────────────> │ 需重新排班 │           │    │
│     │            │(PUBLISHED)  范围变更           │(NEED_REGEN)│           │    │
│     │            │         │                     │           │           │    │
│     │            └────┬────┘                     └───────────┘           │    │
│     │                 │                                                   │    │
│     │                 │ 学期结束                                          │    │
│     │                 ▼                                                   │    │
│     │            ┌─────────┐                                             │    │
│     │            │         │                                             │    │
│     │            │ 已归档  │                                             │    │
│     │            │(ARCHIVED)│                                             │    │
│     │            │         │                                             │    │
│     │            └─────────┘                                             │    │
│     │                                                                     │    │
│     └─────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  状态说明:                                                                       │
│  - DRAFT: 草稿状态，可编辑、可重新排班                                           │
│  - PUBLISHED: 已发布，成员可见，可进行发布后修改                                  │
│  - NEED_REGEN: 排班范围变更，提示管理员重新排班                                   │
│  - ARCHIVED: 学期结束后归档，只读                                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.5.6 Semester Phase 状态机（排班流程主线）

> **设计决策（v2）**：`Semester.phase` 是排班全流程的唯一驱动字段。`schedules.status`（draft/published/archived）退化为排班表内部数据状态，不再驱动前端流程。

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Semester Phase 状态机                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│          激活学期                                                                │
│   ──────────────────> ┌─────────────┐                                          │
│                       │             │ ≥1时段 + ≥1地点 + ≥1人员                  │
│                       │configuring  │ ──────────────────────────────>           │
│                       │  (系统配置)  │                               │          │
│                       └─────────────┘                               │          │
│                              ▲                                       ▼          │
│                              │                              ┌──────────────┐   │
│                              │                              │  collecting  │   │
│                              │   ◄── 回退（保留数据）────── │ (收集时间表) │   │
│                              │                              └──────┬───────┘   │
│                              │                                     │           │
│                              │                              全员已提交          │
│                              │                                     ▼           │
│                              │                              ┌──────────────┐   │
│                              │                              │  scheduling  │   │
│                              │   ◄── 回退（保留数据）────── │   (排班中)   │   │
│                              │                              └──────┬───────┘   │
│                              │                                     │           │
│                              │                              排班表已生成        │
│                              │                           (POST /schedules/auto) │
│                              │                                     ▼           │
│                              │                              ┌──────────────┐   │
│                              │                              │  published   │   │
│                              │   ◄── 回退（保留数据）────── │  (已发布)    │   │
│                              │                              └──────────────┘   │
│                                                                                 │
│  转换触发：                                                                     │
│  - 前进由管理员在 AdminWorkbench Stepper 中点击"下一步"触发                      │
│  - configuring→collecting：点击"激活排班"（Step2）                              │
│  - collecting→scheduling：Step2→Step3（所有人提交后解锁）                       │
│  - scheduling→published：POST /schedules/publish 成功后自动推进                 │
│  - 回退：任意阶段可回退，PUT /semesters/:id/phase（target_phase=前序阶段）      │
│                                                                                 │
│  回退保留策略：                                                                  │
│  - 回退到 configuring：已提交的时间表数据保留（互不影响）                        │
│  - 回退到 collecting：排班表草稿保留（成员可继续修改时间表）                      │
│  - 回退到 scheduling：排班表保留（可继续调整或重新排班）                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**Phase 前进条件（`GET /semesters/:id/phase-check` 返回）：**

| 当前 Phase | 前进至 | 检查项 |
|------------|--------|--------|
| configuring | collecting | ≥1 时间段 ∧ ≥1 地点 ∧ ≥1 值班人员 |
| collecting | scheduling | 所有 duty_required 用户的 timetable_status = submitted |
| scheduling | published | schedules 表存在该学期的记录（status = draft） |

**AutoSchedule Phase 前置校验：**
- `POST /schedules/auto` 要求 `semester.phase = scheduling`，否则返回错误码 13112
- 排班发布（`POST /schedules/publish`）成功后，后端自动将 `semester.phase` 置为 `published`

#### 2.5.7 发布后修改流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         发布后修改流程                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Admin                  Service               Repository            Notify     │
│    │                      │                      │                      │      │
│    │ 1. 修改某时段        │                      │                      │      │
│    │────────────────────>│                      │                      │      │
│    │                      │                      │                      │      │
│    │                      │ 2. 规则校验          │                      │      │
│    │                      │    (同手动调整)      │                      │      │
│    │                      │                      │                      │      │
│    │                      │ 3. 更新排班记录      │                      │      │
│    │                      │────────────────────>│                      │      │
│    │                      │                      │                      │      │
│    │                      │ 4. 记录变更日志      │                      │      │
│    │                      │    - 时段            │                      │      │
│    │                      │    - 原值班人        │                      │      │
│    │                      │    - 新值班人        │                      │      │
│    │                      │    - 操作人          │                      │      │
│    │                      │    - 操作时间        │                      │      │
│    │                      │    - 修改原因        │                      │      │
│    │                      │────────────────────>│                      │      │
│    │                      │                      │                      │      │
│    │                      │ 5. 发送通知          │                      │      │
│    │                      │────────────────────────────────────────────>│      │
│    │                      │    - 通知被替换者    │                      │      │
│    │                      │    - 通知新安排者    │                      │      │
│    │                      │                      │                      │      │
│    │<────────────────────│                      │                      │      │
│    │ 修改成功             │                      │                      │      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.6 换班模块 (Swap)

> **⚠️ 二期工程内容** — 换班模块计划在二期实现，以下为设计预案。数据库表 `swap_requests` 已建立，后端代码待实现。

#### 2.6.1 模块职责

- 换班申请创建
- 目标成员冲突校验
- 审批流程管理
- 换班状态流转
- 换班记录查询

#### 2.6.2 组件结构

```
swap/
├── handler.go          # HTTP 处理器
│   ├── CreateSwap()    # 发起换班申请
│   ├── GetSwap()       # 获取换班详情
│   ├── ListMySwaps()   # 我的换班列表
│   ├── ListPending()   # 待审核列表
│   ├── Respond()       # 目标成员响应
│   ├── Approve()       # 管理员审批
│   └── ListRecords()   # 换班记录
├── service.go          # 业务逻辑
├── validator.go        # 冲突校验
└── repository.go       # 数据访问
```

#### 2.6.3 换班状态机

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           换班申请状态机                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                          ┌───────────────┐                                     │
│                          │               │                                     │
│            创建申请       │    待同意     │                                     │
│          ───────────────>│   (PENDING)   │                                     │
│                          │               │                                     │
│                          └───────┬───────┘                                     │
│                                  │                                              │
│                     ┌────────────┴────────────┐                                │
│                     │                         │                                │
│                     ▼                         ▼                                │
│              ┌─────────────┐          ┌─────────────┐                         │
│              │             │          │             │                         │
│              │  待审核     │          │  已拒绝     │                         │
│              │ (REVIEWING) │          │ (REJECTED)  │                         │
│              │             │          │ (目标拒绝)   │                         │
│              └──────┬──────┘          └─────────────┘                         │
│                     │                                                          │
│          ┌──────────┴──────────┐                                              │
│          │                     │                                              │
│          ▼                     ▼                                              │
│   ┌─────────────┐       ┌─────────────┐                                       │
│   │             │       │             │                                       │
│   │  已完成     │       │  已拒绝     │                                       │
│   │ (COMPLETED) │       │ (REJECTED)  │                                       │
│   │             │       │ (管理员驳回) │                                       │
│   └─────────────┘       └─────────────┘                                       │
│                                                                                 │
│  状态转换触发:                                                                   │
│  - PENDING → REVIEWING: 目标成员同意                                           │
│  - PENDING → REJECTED: 目标成员拒绝                                            │
│  - REVIEWING → COMPLETED: 管理员批准                                           │
│  - REVIEWING → REJECTED: 管理员驳回                                            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.6.4 换班冲突校验

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         换班冲突校验规则                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  申请时校验（申请人发起时）:                                                      │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  1. 截止时间: 班次是否在换班截止时间之前？                                        │
│  2. 排班范围: 目标成员是否在排班范围内？                                         │
│  3. 课表冲突: 目标成员对该时段是否有课？                                         │
│  4. 不可用冲突: 目标成员是否标记该时段不可用？                                    │
│  5. 同日限制: 目标成员当日是否已有其他排班？                                      │
│                                                                                 │
│  审核时校验（管理员批准时，再次校验）:                                            │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  1. 课表冲突: 目标成员对该时段是否有课？（可能时间表已更新）                       │
│  2. 不可用冲突: 目标成员是否标记该时段不可用？                                    │
│  3. 同日限制: 目标成员当日是否已有其他排班？                                      │
│                                                                                 │
│  注: 审核时不再校验截止时间和排班范围                                             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.7 签到模块 (Duty)

> **⚠️ 二期工程内容** — 签到签退模块计划在二期实现，以下为设计预案。数据库表 `duty_records` 已建立，后端代码待实现。

#### 2.7.1 模块职责

- 签到操作与记录
- 签退操作与记录
- 时间窗口校验
- 缺席自动检测
- 补签处理
- 出勤记录查询

#### 2.7.2 组件结构

```
duty/
├── handler.go          # HTTP 处理器
│   ├── SignIn()        # 签到
│   ├── SignOut()       # 签退
│   ├── MakeUpSign()    # 补签
│   ├── GetTodayDuty()  # 获取今日值班
│   ├── ListMyRecords() # 我的出勤记录
│   └── ListAbnormal()  # 异常记录（管理员）
├── service.go          # 业务逻辑
├── checker.go          # 定时检测任务
└── repository.go       # 数据访问
```

#### 2.7.3 签到签退时间窗口

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         签到签退时间窗口                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  以 08:10 - 10:05 时段为例:                                                      │
│                                                                                 │
│  07:55        08:10        08:25                      09:50        10:05        10:20
│    │           │            │                          │            │            │
│    │<── 签到窗口 ──>│<── 迟到区 ──>│                    │<── 签退窗口 ──>│
│    │           │            │                          │            │
│    │  正常签到  │   迟到签到  │    超时=缺席             │  正常签退   │
│    │           │            │                          │            │
│  ──┼───────────┼────────────┼──────────────────────────┼────────────┼───────────
│    │           │            │                          │            │
│  T-15min      T开始       T+15min                    T结束-15min   T结束      T结束+15min
│                                                                                 │
│  签到规则:                                                                       │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  • 签到窗口: [T-15min, T+15min]                                                 │
│  • T-15min ~ T: 正常签到                                                        │
│  • T ~ T+15min: 迟到签到                                                        │
│  • > T+15min 未签到: 系统自动标记缺席                                            │
│                                                                                 │
│  签退规则:                                                                       │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  • 签退窗口: [T结束-15min, T结束+15min]                                          │
│  • 必须已签到才能签退                                                            │
│  • > T结束+15min 未签退: 系统通知管理员                                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.7.4 值班记录状态机

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         值班记录状态机                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                          ┌───────────────┐                                     │
│                          │               │                                     │
│           排班生成        │    待值班     │                                     │
│          ───────────────>│   (PENDING)   │                                     │
│                          │               │                                     │
│                          └───────┬───────┘                                     │
│                                  │                                              │
│                     ┌────────────┼────────────┐                                │
│                     │            │            │                                │
│                     │ 正常签到    │ 迟到签到   │ 超时未签到                      │
│                     ▼            ▼            ▼                                │
│              ┌──────────┐ ┌──────────┐ ┌──────────┐                           │
│              │ 值班中   │ │ 值班中   │ │  缺席    │                           │
│              │(ON_DUTY) │ │(ON_DUTY) │ │(ABSENT)  │                           │
│              │ 准时     │ │ 迟到     │ │          │                           │
│              └────┬─────┘ └────┬─────┘ └────┬─────┘                           │
│                   │            │            │                                  │
│                   │ 签退       │ 签退       │ 补签                             │
│                   ▼            ▼            ▼                                  │
│              ┌──────────┐ ┌──────────┐ ┌──────────┐                           │
│              │ 已完成   │ │ 已完成   │ │ 缺席     │                           │
│              │(COMPLETED)│ │(COMPLETED)│ │(已补签)  │                           │
│              │ 准时     │ │ 迟到     │ │(ABSENT   │                           │
│              └──────────┘ └──────────┘ │ MADE_UP) │                           │
│                                        └──────────┘                           │
│                                                                                 │
│  未签退处理:                                                                     │
│  • 签到后超过 T结束+15min 未签退 → 标记为 NO_SIGN_OUT                            │
│  • 通知管理员处理                                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 2.7.5 定时检测任务

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         定时检测任务设计                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  任务1: 缺席检测 (每分钟执行)                                                    │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  1. 查询所有"待值班"状态且 开始时间+15min < 当前时间 的记录                       │
│  2. 将状态更新为"缺席"                                                          │
│  3. 为每条记录发送通知给管理员                                                   │
│                                                                                 │
│  任务2: 未签退检测 (每分钟执行)                                                  │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  1. 查询所有"值班中"状态且 结束时间+15min < 当前时间 的记录                       │
│  2. 将状态更新为"未签退"                                                        │
│  3. 为每条记录发送通知给管理员                                                   │
│                                                                                 │
│  任务3: 值班提醒 (每日配置时间执行，默认09:00)                                    │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  1. 查询明天所有的值班安排                                                       │
│  2. 检查每个成员的通知偏好（是否开启值班提醒）                                    │
│  3. 为开启提醒的成员发送邮件通知                                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.8 通知模块 (Notification)

> **⚠️ 二期工程内容** — 通知模块计划在二期实现，以下为设计预案。数据库表 `notifications` 和 `notification_preferences` 已建立，后端代码待实现。

#### 2.8.1 模块职责

- 邮件发送（SMTP）
- 站内消息管理
- 通知偏好设置
- 通知模板管理
- 发送记录与重试

#### 2.8.2 组件结构

```
notification/
├── handler.go          # HTTP 处理器
│   ├── ListMessages()  # 消息列表
│   ├── MarkRead()      # 标记已读
│   ├── GetPreference() # 获取偏好设置
│   └── UpdatePreference()# 更新偏好设置
├── service.go          # 业务逻辑
│   ├── SendEmail()     # 发送邮件
│   ├── CreateMessage() # 创建站内消息
│   └── NotifyXxx()     # 各类通知方法
├── email.go            # 邮件发送
├── template.go         # 邮件模板
└── repository.go       # 数据访问
```

#### 2.8.3 通知类型与触发时机

| 通知类型 | 触发时机 | 接收人 | 默认开启 | 可配置 |
|----------|----------|--------|----------|--------|
| 排班发布 | 排班表发布时 | 所有值班成员 | ✅ | ✅ |
| 排班变更 | 发布后修改时 | 受影响成员 | ✅ | ✅ |
| 值班提醒 | 值班前1天 | 值班成员 | ✅ | ✅ |
| 换班申请 | 发起换班时 | 目标成员 | ✅ | ❌ |
| 换班响应 | 同意/拒绝时 | 申请人 | ✅ | ❌ |
| 换班审核结果 | 管理员审批后 | 双方成员 | ✅ | ❌ |
| 缺席通知 | 成员被标记缺席 | 管理员 | ✅ | ✅ |
| 补签通知 | 成员补签后 | 管理员 | ✅ | ✅ |
| 未签退通知 | 超时未签退 | 管理员 | ✅ | ✅ |

#### 2.8.4 邮件模板示例

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         邮件模板: 值班提醒                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  主题: 【值班提醒】您明天有值班安排                                               │
│                                                                                 │
│  正文:                                                                          │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  {{.Name}} 您好：                                                               │
│                                                                                 │
│  您明天（{{.Date}}）有值班安排，请注意时间：                                      │
│                                                                                 │
│  • 时间：{{.TimeSlot}}                                                          │
│  • 地点：{{.Location}}                                                          │
│                                                                                 │
│  请提前15分钟到达并完成签到。                                                     │
│                                                                                 │
│  如需换班，请在截止时间前在系统中发起申请。                                        │
│                                                                                 │
│  ───────────────────────────────────                                           │
│  学生会值班管理系统                                                              │
│  {{.SystemURL}}                                                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.9 配置模块 (Config)

#### 2.9.1 模块职责

- 学期管理（CRUD、激活）
- 时间段配置
- 排班规则开关
- 系统参数配置
- 值班地点管理（预留）

#### 2.9.2 组件结构

```
config/
├── handler.go          # HTTP 处理器
│   ├── GetSemester()   # 获取学期
│   ├── ListSemesters() # 学期列表
│   ├── CreateSemester()# 创建学期
│   ├── UpdateSemester()# 更新学期
│   ├── ActivateSemester()# 激活学期
│   ├── GetTimeSlots()  # 获取时间段
│   ├── UpdateTimeSlots()# 更新时间段
│   ├── GetRules()      # 获取规则配置
│   ├── UpdateRules()   # 更新规则配置
│   └── GetSettings()   # 获取系统设置
├── service.go          # 业务逻辑
└── repository.go       # 数据访问
```

#### 2.9.3 学期配置数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | VARCHAR | 学期名称（如"2025-2026学年第二学期"） |
| start_date | DATE | 开始日期 |
| end_date | DATE | 结束日期 |
| first_week_type | ENUM | 首周类型（ODD/EVEN，单周/双周） |
| is_active | BOOLEAN | 是否为当前活动学期 |
| status | ENUM | 状态（ACTIVE/ARCHIVED） |

#### 2.9.4 时间段配置数据结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | VARCHAR | 时段名称（如"第一时段"） |
| start_time | TIME | 开始时间 |
| end_time | TIME | 结束时间 |
| day_type | ENUM | 适用日类型（WEEKDAY/FRIDAY） |
| sort_order | INT | 排序序号 |

**默认时间段配置：**

| 日类型 | 时段名 | 时间 |
|--------|--------|------|
| 周一~四 | 第一时段 | 08:10 - 10:05 |
| 周一~四 | 第二时段 | 10:20 - 12:15 |
| 周一~四 | 第三时段 | 14:00 - 16:00 |
| 周一~四 | 第四时段 | 16:10 - 18:00 |
| 周五 | 第一时段 | 08:10 - 10:05 |
| 周五 | 第二时段 | 10:20 - 12:15 |
| 周五 | 第三时段 | 14:00 - 16:00 |

---

### 2.10 导出模块 (Export)

#### 2.10.1 模块职责

- 排班表导出（Excel）
- 签到统计导出（Excel）

#### 2.10.2 组件结构

```
export/
├── handler.go          # HTTP 处理器
│   ├── ExportSchedule()# 导出排班表
│   └── ExportDutyStats()# 导出签到统计
├── service.go          # 业务逻辑
└── excel.go            # Excel生成
```

#### 2.10.3 排班表导出格式

| 列 | 说明 |
|----|------|
| 日期 | 值班日期 |
| 星期 | 星期几 |
| 周类型 | 单周/双周 |
| 时间段 | 开始-结束时间 |
| 值班人员 | 姓名 |
| 部门 | 所属部门 |
| 地点 | 值班地点 |

#### 2.10.4 签到统计导出格式

| 列 | 说明 |
|----|------|
| 姓名 | 成员姓名 |
| 学号 | 学号 |
| 部门 | 所属部门 |
| 班次日期 | 值班日期 |
| 班次时间 | 时间段 |
| 签到时间 | 实际签到时间 |
| 签退时间 | 实际签退时间 |
| 状态 | 准时/迟到/缺席/缺席已补签/未签退 |

---

## 三、前端页面设计

### 3.1 页面路由结构

> **v2 重构**：去掉侧边栏，改为顶部导航；路由精简为工作台（角色分流）+ 用户管理 + 个人中心三个核心页面，旧路由全部重定向到 `/`。

```
/                 → 工作台（角色分流：admin → AdminWorkbench; leader → LeaderWorkbench; member → MemberWorkbench）
/users            → 用户管理页（仅 admin，含"成员列表 | 部门管理 | 学期管理" Tab）
/profile          → 个人中心（所有角色）
/login            → 登录页（公开）
/403              → 权限错误页
*                 → 404 页面

──── 旧路由（全部 redirect 到 / 或对应新路由）────
/dashboard        → redirect /
/schedule         → redirect /
/schedule/auto    → redirect /
/schedule/adjust  → redirect /
/timetable        → redirect /
/admin/config     → redirect /
/admin/departments → redirect /users
/admin/progress   → redirect /
/admin/users      → redirect /users
```

**顶部导航栏（替代侧边栏）：**

| 角色 | 导航项 |
|------|--------|
| admin | 工作台（/）、用户管理（/users） |
| leader / member | 工作台（/） |
| 全部 | 右侧头像下拉：个人中心（/profile）、退出登录 |

### 3.2 关键页面组件设计

#### 3.2.1 工作台 (Workbench) — v2

工作台按角色分流：`admin` → `AdminWorkbench`；`leader` → `LeaderWorkbench`；`member` → `MemberWorkbench`。

**AdminWorkbench — 4步 Stepper 向导：**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ AdminWorkbench 组件结构（Ant Design Steps, current 由 Semester.phase 驱动）      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌── Stepper ──────────────────────────────────────────────────────────────┐   │
│  │  [1. 系统配置]  →  [2. 收集时间表]  →  [3. 排班]  →  [4. 排班结果]    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  Step 1 (configuring):                                                          │
│    ├── <Tabs>: 时间段配置 | 地点配置 | 排班规则（复用现有子组件）               │
│    └── 完成条件清单 + "下一步：选定人员" 按钮（条件不满足时 disabled + tooltip）  │
│                                                                                 │
│  Step 2 (collecting):                                                           │
│    ├── <DutyMemberSelector>: 按部门分组 checkbox，支持部门全选                  │
│    └── "激活排班" 按钮 → phase: configuring→collecting                          │
│                                                                                 │
│  Step 3 (scheduling) — 三种子视图按数据状态自动切换：                           │
│    ├── 等待提交（提交率 < 100%）：进度条 + 成员状态列表（只读）                 │
│    ├── 自动排班（提交率=100% 且无排班表）：PreCheckPanel + 开始自动排班          │
│    └── 手动调整（排班表已生成 draft 状态）：ScheduleWeekGrid（可编辑） + 底部确认 │
│                                                                                 │
│  Step 4 (published):                                                            │
│    ├── <ScheduleWeekGrid>（只读）+ <WeekSelector>                               │
│    ├── [发布排班表] 按钮（在 scheduling 阶段点"确认排班"时自动触发）             │
│    ├── [导出 Excel] 按钮                                                        │
│    └── [返回调整] 按钮 → phase 回退到 scheduling                                │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

**MemberWorkbench — 待办驱动：**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ MemberWorkbench 组件结构                                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  顶部待办卡片区（根据 Phase + 个人状态动态显示）：                               │
│                                                                                 │
│   Phase           个人状态        卡片内容                                      │
│   ──────────────  ──────────────  ────────────────────────────────────────      │
│   collecting      未提交           「请提交你的时间表」→ 展开内嵌时间表填写区      │
│   collecting      已提交           「已提交，等待排班中」（静态）                 │
│   scheduling      —               「排班进行中，请耐心等待」                     │
│   published       —               「排班已发布」→ 点击滚动到排班视图             │
│   无活跃学期      —               「暂无排班任务」                               │
│                                                                                 │
│  collecting + 未提交 时，下方内嵌：                                              │
│    └── <TimetablePage>（时间表填写 + 提交按钮）                                 │
│                                                                                 │
│  published 时，下方展示：                                                       │
│    └── <ScheduleWeekGrid>（只读，过滤当前用户）                                  │
│                                                                                 │
│  Leader 额外视图（collecting 阶段）：                                           │
│    └── 「本部门提交进度」折叠面板：成员列表 + 提交状态标签                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 时间表页面 (TimeTable)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ TimeTable 组件结构                                                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  <TimeTablePage>                                                                │
│    │                                                                            │
│    ├── <PageHeader>                                                             │
│    │     ├── 提交状态标签                                                       │
│    │     └── [提交时间表] 按钮                                                  │
│    │                                                                            │
│    ├── <ImportToolbar>              # 导入工具栏                                │
│    │     ├── [ICS文件导入] 按钮                                                 │
│    │     ├── [ICS链接导入] 按钮                                                 │
│    │     └── [添加不可用时间] 按钮                                              │
│    │                                                                            │
│    ├── <WeekCalendar>               # 周视图日历 (FullCalendar)                 │
│    │     ├── 课表事件（蓝色）                                                   │
│    │     ├── 不可用时间（橙色）                                                 │
│    │     └── 拖拽选择功能                                                       │
│    │                                                                            │
│    ├── <ICSImportModal>             # ICS导入弹窗                               │
│    │     ├── 文件上传                                                           │
│    │     └── 链接输入                                                           │
│    │                                                                            │
│    └── <UnavailableFormModal>       # 不可用时间表单弹窗                         │
│          ├── 时间选择                                                           │
│          ├── 原因输入                                                           │
│          └── 重复设置（单次/每周/双周）                                              │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.3 排班概览页面 (Schedule)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ Schedule 组件结构                                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  <SchedulePage>                                                                 │
│    │                                                                            │
│    ├── <ScheduleToolbar>            # 工具栏                                    │
│    │     ├── [单周/双周] 切换                                                   │
│    │     ├── [日历/列表] 视图切换                                               │
│    │     ├── [仅看我的] 开关（成员）                                            │
│    │     ├── 部门筛选（管理员/负责人）                                          │
│    │     └── [导出Excel] 按钮（管理员）                                         │
│    │                                                                            │
│    ├── <ScheduleCalendar>           # 日历视图                                  │
│    │     └── <ScheduleSlot>         # 时段卡片                                  │
│    │           ├── 时间                                                         │
│    │           ├── 值班人员                                                     │
│    │           ├── 部门                                                         │
│    │           └── [换班] 按钮（成员本人班次）                                   │
│    │                                                                            │
│    └── <ScheduleList>               # 列表视图                                  │
│          └── 表格形式展示                                                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、错误处理设计

### 4.1 错误码定义

| 错误码 | 含义 | HTTP状态码 |
|--------|------|------------|
| 0 | 成功 | 200 |
| **10000-10999** | **通用错误** | |
| 10001 | 参数校验失败 | 400 |
| 10002 | 未授权（未登录） | 401 |
| 10003 | 禁止访问（无权限） | 403 |
| 10004 | 资源不存在 | 404 |
| 10005 | 服务器内部错误 | 500 |
| **11000-11999** | **认证错误** | |
| 11001 | 学号或密码错误 | 401 |
| 11002 | Token已过期 | 401 |
| 11003 | Token无效 | 401 |
| 11004 | 邀请码无效或已过期 | 400 |
| 11005 | 邮箱已被注册 | 400 |
| 11006 | 学号已被注册 | 400 |
| **12000-12999** | **用户错误** | |
| 12001 | 用户不存在 | 404 |
| 12002 | 无法修改自己的角色 | 400 |
| 12003 | 部门下存在成员，无法删除 | 400 |
| **13000-13999** | **排班错误** | |
| 13001 | 提交率未达100%，无法排班 | 400 |
| 13002 | 排班正在进行中 | 400 |
| 13003 | 排班规则冲突 | 400 |
| 13004 | 成员不在排班范围内 | 400 |
| 13005 | 成员时间冲突 | 400 |
| 13006 | 需要重新排班 | 400 |
| **14000-14999** | **换班错误** | |
| 14001 | 已超过换班截止时间 | 400 |
| 14002 | 目标成员不在排班范围 | 400 |
| 14003 | 目标成员时间冲突 | 400 |
| 14004 | 目标成员当日已有排班 | 400 |
| 14005 | 换班申请不存在 | 404 |
| 14006 | 换班状态不允许此操作 | 400 |
| **15000-15999** | **签到错误** | |
| 15001 | 当前不在签到时间窗口 | 400 |
| 15002 | 当前不在签退时间窗口 | 400 |
| 15003 | 已签到，请勿重复签到 | 400 |
| 15004 | 未签到，无法签退 | 400 |
| 15005 | 值班记录不存在 | 404 |

### 4.2 错误响应格式

```json
{
  "code": 13003,
  "message": "排班规则冲突",
  "details": {
    "violations": [
      {
        "rule": "R3",
        "message": "该成员部门当天已有人值班"
      }
    ]
  }
}
```

---

## 五、日志设计

### 5.1 日志级别

| 级别 | 用途 |
|------|------|
| DEBUG | 开发调试信息 |
| INFO | 正常业务操作记录 |
| WARN | 警告信息（不影响业务） |
| ERROR | 错误信息（影响业务） |

### 5.2 日志格式

```json
{
  "level": "INFO",
  "time": "2026-01-29T10:30:00Z",
  "caller": "auth/service.go:45",
  "msg": "用户登录成功",
  "user_id": "uuid",
  "email": "user@example.com",
  "ip": "192.168.1.1",
  "request_id": "uuid"
}
```

### 5.3 关键操作日志

| 操作 | 日志级别 | 记录内容 |
|------|----------|----------|
| 用户登录 | INFO | 用户ID、IP |
| 用户登出 | INFO | 用户ID |
| 角色变更 | INFO | 操作人、目标用户、新角色 |
| 执行排班 | INFO | 操作人、学期、结果 |
| 发布排班 | INFO | 操作人、学期 |
| 排班修改 | INFO | 操作人、时段、原/新人员 |
| 换班审批 | INFO | 操作人、申请ID、结果 |
| 缺席标记 | WARN | 成员、时段 |
| 系统错误 | ERROR | 错误详情、堆栈 |

---

## 六、基础设施实现备注

### 6.1 数据库连接池

数据库连接池参数 `MaxOpenConns` 与 `MaxIdleConns` 已改为从配置文件读取（`config.yaml` 中的 `database.max_open_conns` 和 `database.max_idle_conns`），而非硬编码。`pkg/database/db.go` 在初始化时读取配置并设置连接池参数，未配置时使用合理默认值。

---

## 版本历史

| 版本 | 日期 | 修改内容 | 修改人 |
|------|------|----------|--------|
| v1.0 | 2026-01-29 | 初稿 | 系统架构师 |
| v1.1 | 2026-02-26 | 同步代码实现进度：<br>1. 不可用时间新增 `biweekly`（双周）repeat_type 及其约束<br>2. 补充 `CreateUnavailableTimeRequest.Validate()` 方法说明<br>3. 数据库连接池参数已改为从配置文件读取<br>4. Excel 导入解析逻辑已移至 Service 层 | 文档同步助手 |

